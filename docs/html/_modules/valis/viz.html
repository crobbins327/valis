

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>valis.viz &mdash; valis &#34;1.0.0rc11&#34;
 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: black" >
          

          
            <a href="../../index.html">
          

          
            
            <img src="../../_static/valis_logo_black_no_bg.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../registration.html">Registration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../slide_io.html">Slide I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../preprocessing.html">Image pre-processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../feature_detectors.html">Feature detectors and descriptors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../feature_matcher.html">Feature matching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../affine_optimizer.html">Affine optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../non_rigid_registrars.html">Non-rigid registration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../serial_rigid.html">Serial rigid registration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../serial_non_rigid.html">Serial non-rigid registration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../viz.html">Visualization</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">valis</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>valis.viz</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for valis.viz</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Various functions used to visualize registration results</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">colour</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="n">draw</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">exposure</span><span class="p">,</span> <span class="n">transform</span>
<span class="kn">from</span> <span class="nn">scipy.cluster.hierarchy</span> <span class="kn">import</span> <span class="n">dendrogram</span>
<span class="kn">from</span> <span class="nn">scipy.spatial</span> <span class="kn">import</span> <span class="n">distance</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numba</span> <span class="k">as</span> <span class="nn">nb</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">warp_tools</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="c1"># JzAzBz #</span>
<span class="n">DXDY_CSPACE</span> <span class="o">=</span> <span class="s2">&quot;JzAzBz&quot;</span>
<span class="n">DXDY_CRANGE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.025</span><span class="p">)</span>
<span class="n">DXDY_LRANGE</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.004</span><span class="p">,</span> <span class="mf">0.015</span><span class="p">)</span>

<span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;Windows&#39;</span> <span class="ow">or</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;Darwin&#39;</span><span class="p">:</span>
    <span class="n">uniTupleDtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">uniTupleDtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span>


<span class="c1"># CAM16-UCS #</span>
<span class="c1"># DXDY_CSPACE = &quot;CAM16UCS&quot;</span>
<span class="c1"># DXDY_CRANGE = (0, 0.5)</span>
<span class="c1"># DXDY_LRANGE = (0.5, 0.9)</span>


<span class="k">def</span> <span class="nf">draw_outline</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">clr</span><span class="o">=</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="mi">39</span><span class="p">),</span> <span class="n">thickness</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Draw mask outline around an image</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    img : ndarray</span>
<span class="sd">        Image on which to draw the mask outline</span>


<span class="sd">    mask : ndarray</span>
<span class="sd">        Mask to draw outline of</span>

<span class="sd">    clr : ndarray</span>
<span class="sd">        RGB (0-255) color of outline</span>

<span class="sd">    thicknes : int</span>
<span class="sd">        Thickness of outline</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    outline_img : ndarray</span>
<span class="sd">        Copy of `img` with the outline of `mask` drawn on it</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">outline_img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">outline_img</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">outline_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">([</span><span class="n">outline_img</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>

    <span class="n">outline_img</span> <span class="o">=</span> <span class="n">outline_img</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

    <span class="n">detection_mask</span> <span class="o">=</span> <span class="mi">255</span><span class="o">*</span><span class="p">(</span><span class="n">mask</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="n">contours</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">findContours</span><span class="p">(</span><span class="n">detection_mask</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">RETR_EXTERNAL</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CHAIN_APPROX_SIMPLE</span><span class="p">)</span>
    <span class="n">int_color</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clr</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">cnt</span> <span class="ow">in</span> <span class="n">contours</span><span class="p">:</span>
        <span class="n">outline_img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">drawContours</span><span class="p">(</span><span class="n">outline_img</span><span class="p">,</span> <span class="p">[</span><span class="n">cnt</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">int_color</span><span class="p">,</span> <span class="n">thickness</span><span class="o">=</span><span class="n">thickness</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">outline_img</span>


<div class="viewcode-block" id="draw_features"><a class="viewcode-back" href="../../viz.html#valis.viz.draw_features">[docs]</a><span class="k">def</span> <span class="nf">draw_features</span><span class="p">(</span><span class="n">kp_xy</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">n_features</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Draw keypoints on a image</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">image</span> <span class="o">=</span> <span class="n">exposure</span><span class="o">.</span><span class="n">rescale_intensity</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">out_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">feature_img</span> <span class="o">=</span> <span class="n">color</span><span class="o">.</span><span class="n">grey2rgb</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">feature_img</span> <span class="o">=</span> <span class="n">image</span>

    <span class="n">rad</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">feature_img</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>

    <span class="n">n_kp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">kp_xy</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n_kp</span> <span class="o">&lt;</span> <span class="n">n_features</span><span class="p">:</span>
        <span class="n">n_features</span> <span class="o">=</span> <span class="n">n_kp</span>

    <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">kp_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">n_features</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">):</span>
        <span class="n">circ_r</span><span class="p">,</span> <span class="n">circ_c</span> <span class="o">=</span> <span class="n">draw</span><span class="o">.</span><span class="n">circle_perimeter</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">rad</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">feature_img</span><span class="p">[</span><span class="n">circ_r</span><span class="p">,</span> <span class="n">circ_c</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">feature_img</span></div>


<div class="viewcode-block" id="draw_matches"><a class="viewcode-back" href="../../viz.html#valis.viz.draw_matches">[docs]</a><span class="k">def</span> <span class="nf">draw_matches</span><span class="p">(</span><span class="n">src_img</span><span class="p">,</span> <span class="n">kp1_xy</span><span class="p">,</span> <span class="n">dst_img</span><span class="p">,</span> <span class="n">kp2_xy</span><span class="p">,</span> <span class="n">rad</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">alignment</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Draw feature matches between two images</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src_img : ndarray</span>
<span class="sd">        Image associated with `kp1_xy`</span>

<span class="sd">    kp1_xy : ndarray</span>
<span class="sd">        xy coordinates of feature points found in `src_img`</span>

<span class="sd">    dst_img : ndarray</span>
<span class="sd">        Image associated with `kp2_xy`</span>

<span class="sd">    kp2_xy : ndarray</span>
<span class="sd">        xy coordinates of feature points found in `dst_img`</span>

<span class="sd">    rad : int</span>
<span class="sd">        Radius of circles used to draw feature points</span>

<span class="sd">    alignment : string</span>
<span class="sd">        How to stack the images, either &#39;veritcal&#39; or &#39;horizontal&#39;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    feature_img : ndarray</span>
<span class="sd">        Image show corresponding features of `src_img` and `dst_img`</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">all_dims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">src_img</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dst_img</span><span class="o">.</span><span class="n">shape</span><span class="p">])</span>
    <span class="n">out_shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">all_dims</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">padded_src</span><span class="p">,</span> <span class="n">src_T</span> <span class="o">=</span> <span class="n">warp_tools</span><span class="o">.</span><span class="n">pad_img</span><span class="p">(</span><span class="n">src_img</span><span class="p">,</span> <span class="n">out_shape</span><span class="p">)</span>
    <span class="n">padded_dst</span><span class="p">,</span> <span class="n">dst_T</span> <span class="o">=</span> <span class="n">warp_tools</span><span class="o">.</span><span class="n">pad_img</span><span class="p">(</span><span class="n">dst_img</span><span class="p">,</span> <span class="n">out_shape</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">alignment</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;v&quot;</span><span class="p">):</span>
        <span class="n">feature_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">padded_src</span><span class="p">,</span> <span class="n">padded_dst</span><span class="p">])</span>
        <span class="n">dst_xy_shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">out_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">feature_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">padded_src</span><span class="p">,</span> <span class="n">padded_dst</span><span class="p">])</span>
        <span class="n">dst_xy_shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">out_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">feature_img</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">feature_img</span> <span class="o">=</span> <span class="n">color</span><span class="o">.</span><span class="n">gray2rgb</span><span class="p">(</span><span class="n">feature_img</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

    <span class="n">dst_T</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-=</span> <span class="n">dst_xy_shift</span>
    <span class="n">dst_xy_in_feature_img</span> <span class="o">=</span> <span class="n">warp_tools</span><span class="o">.</span><span class="n">warp_xy</span><span class="p">(</span><span class="n">kp2_xy</span><span class="p">,</span> <span class="n">M</span><span class="o">=</span><span class="n">dst_T</span><span class="p">)</span>

    <span class="n">n_pt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">kp1_xy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">kp2_xy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="o">*</span><span class="n">jzazbz_cmap</span><span class="p">())</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="n">all_color_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">cmap</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">all_color_idx</span><span class="p">,</span> <span class="n">n_pt</span><span class="p">),</span> <span class="p">:]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_pt</span><span class="p">):</span>

        <span class="n">xy1</span> <span class="o">=</span> <span class="n">kp1_xy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">xy2</span> <span class="o">=</span> <span class="n">dst_xy_in_feature_img</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">pt_color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="n">circ_rc_1</span> <span class="o">=</span> <span class="n">draw</span><span class="o">.</span><span class="n">ellipse</span><span class="p">(</span><span class="o">*</span><span class="n">xy1</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">rad</span><span class="p">,</span> <span class="n">rad</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">feature_img</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">circ_rc_2</span> <span class="o">=</span> <span class="n">draw</span><span class="o">.</span><span class="n">ellipse</span><span class="p">(</span><span class="o">*</span><span class="n">xy2</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">rad</span><span class="p">,</span> <span class="n">rad</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">feature_img</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">line_rc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">draw</span><span class="o">.</span><span class="n">line_aa</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">xy1</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> <span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">xy2</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)))</span>
        <span class="n">line_rc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">line_rc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">feature_img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">line_rc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">line_rc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">feature_img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="n">feature_img</span><span class="p">[</span><span class="n">line_rc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> <span class="n">line_rc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)]</span> <span class="o">=</span> <span class="n">pt_color</span><span class="o">*</span><span class="n">line_rc</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="n">feature_img</span><span class="p">[</span><span class="n">circ_rc_1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pt_color</span>
        <span class="n">feature_img</span><span class="p">[</span><span class="n">circ_rc_2</span><span class="p">]</span> <span class="o">=</span> <span class="n">pt_color</span>

    <span class="k">return</span> <span class="n">feature_img</span></div>


<span class="k">def</span> <span class="nf">draw_clusterd_D</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">optimal_Z</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Draw clustered distance matrix with dendrograms along the axes</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">axdendro</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.013</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.798</span><span class="p">])</span>

    <span class="n">Z</span> <span class="o">=</span> <span class="n">dendrogram</span><span class="p">(</span><span class="n">optimal_Z</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">link_color_func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">)</span>
    <span class="n">axdendro</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
    <span class="n">axdendro</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
    <span class="n">axdendro</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    <span class="n">axdendro</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>

    <span class="n">axdendro_top</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.115</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.14</span><span class="p">])</span>
    <span class="n">Z_top</span> <span class="o">=</span> <span class="n">dendrogram</span><span class="p">(</span><span class="n">optimal_Z</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">link_color_func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">)</span>
    <span class="n">axdendro_top</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
    <span class="n">axdendro_top</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
    <span class="n">axdendro_top</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

    <span class="n">axmatrix</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.115</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.798</span><span class="p">])</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">axmatrix</span><span class="o">.</span><span class="n">matshow</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;plasma_r&quot;</span><span class="p">)</span>
    <span class="n">axmatrix</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
    <span class="n">axmatrix</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>

    <span class="n">axcolor</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.798</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">axcolor</span><span class="p">)</span>


<span class="c1"># Non-rigid visualization #</span>
<span class="nd">@nb</span><span class="o">.</span><span class="n">njit</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">get_grid</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">grid_spacing</span><span class="p">,</span> <span class="n">thickness</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get points for a grid. Can be used to view deformation field</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    shape : (int, int)</span>
<span class="sd">        dimensions of image upon which the grid will be drawn</span>

<span class="sd">    grid_spacing : int</span>
<span class="sd">        Space between grid points</span>

<span class="sd">    thickness : int, optional</span>
<span class="sd">        line thickness</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    grid_rows, grid_cols : 2 ndarray</span>
<span class="sd">        2, 1D arrays, which each element corresponding to a point in the grid</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">all_rows</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">all_cols</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">row_add_idx</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">thickness</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">grid_spacing</span> <span class="o">-</span> <span class="n">thickness</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">thickness</span><span class="p">,</span> <span class="n">grid_spacing</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">k</span><span class="o">%</span><span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">row_add_idx</span>
                <span class="k">elif</span> <span class="n">k</span><span class="o">%</span><span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="n">row_add_idx</span>

                <span class="k">if</span> <span class="n">r</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">all_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                    <span class="n">all_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">k</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">row_add_idx</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">col_add_idx</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">thickness</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">grid_spacing</span> <span class="o">-</span> <span class="n">thickness</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">grid_spacing</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">k</span><span class="o">%</span><span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="n">col_add_idx</span>
                <span class="k">elif</span> <span class="n">k</span><span class="o">%</span><span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="n">j</span> <span class="o">-</span> <span class="n">col_add_idx</span>

                <span class="k">if</span> <span class="n">c</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">all_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="n">all_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">k</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">col_add_idx</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_rows</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">uniTupleDtype</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_cols</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">uniTupleDtype</span><span class="p">)</span>


<div class="viewcode-block" id="jzazbz_cmap"><a class="viewcode-back" href="../../viz.html#valis.viz.jzazbz_cmap">[docs]</a><span class="k">def</span> <span class="nf">jzazbz_cmap</span><span class="p">(</span><span class="n">luminosity</span><span class="o">=</span><span class="mf">0.012</span><span class="p">,</span> <span class="n">colorfulness</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">max_h</span><span class="o">=</span><span class="mi">260</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get colormap based on JzAzBz colorspace, which has good hue linearity.</span>
<span class="sd">    Already preceptually uniform.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    luminosity :  float, optional</span>

<span class="sd">    colorfulness : float, optional</span>

<span class="sd">    max_h : int, optional</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">360</span><span class="p">))</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">colorfulness</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">colorfulness</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">luminosity</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">h</span><span class="p">))</span>

    <span class="n">jzazbz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">([</span><span class="n">j</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>
    <span class="k">with</span> <span class="n">colour</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">suppress_warnings</span><span class="p">(</span><span class="n">colour_usage_warnings</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">rgb</span> <span class="o">=</span> <span class="n">colour</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">jzazbz</span><span class="p">,</span> <span class="s1">&#39;JzAzBz&#39;</span><span class="p">,</span> <span class="s1">&#39;sRGB&#39;</span><span class="p">)</span>

    <span class="n">rgb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">rgb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">max_h</span> <span class="o">!=</span> <span class="mi">360</span><span class="p">:</span>
        <span class="n">rgb</span> <span class="o">=</span> <span class="n">rgb</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">max_h</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">rgb</span></div>

<div class="viewcode-block" id="cam16ucs_cmap"><a class="viewcode-back" href="../../viz.html#valis.viz.cam16ucs_cmap">[docs]</a><span class="k">def</span> <span class="nf">cam16ucs_cmap</span><span class="p">(</span><span class="n">luminosity</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">colorfulness</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">max_h</span><span class="o">=</span><span class="mi">300</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get colormap based on CAM16-UCS colorspace.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    luminosity :  float, optional</span>

<span class="sd">    colorfulness : float, optional</span>

<span class="sd">    max_h : int, optional</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">360</span><span class="p">))</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">colorfulness</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">colorfulness</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">luminosity</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">h</span><span class="p">))</span>

    <span class="n">eps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="s2">&quot;float&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span>
    <span class="n">cam</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">([</span><span class="n">j</span><span class="p">,</span> <span class="n">a</span><span class="o">+</span><span class="n">eps</span><span class="p">,</span> <span class="n">b</span><span class="o">+</span><span class="n">eps</span><span class="p">])</span>
    <span class="k">with</span> <span class="n">colour</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">suppress_warnings</span><span class="p">(</span><span class="n">colour_usage_warnings</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">rgb</span> <span class="o">=</span> <span class="n">colour</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="s1">&#39;CAM16UCS&#39;</span><span class="p">,</span> <span class="s1">&#39;sRGB&#39;</span><span class="p">)</span>

    <span class="n">rgb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">rgb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">max_h</span> <span class="o">!=</span> <span class="mi">360</span><span class="p">:</span>
        <span class="n">rgb</span> <span class="o">=</span> <span class="n">rgb</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">max_h</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">rgb</span></div>



<span class="k">def</span> <span class="nf">make_cbar</span><span class="p">(</span><span class="n">rgb</span><span class="p">,</span> <span class="n">bar_height</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
    <span class="n">cbar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">rgb</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">bar_height</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

    <span class="k">return</span> <span class="n">cbar</span>


<span class="k">def</span> <span class="nf">rgb_triangle_cmap</span><span class="p">():</span>

    <span class="n">total_n</span> <span class="o">=</span> <span class="mi">360</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">total_n</span><span class="o">//</span><span class="mi">3</span>
    <span class="n">max_v</span> <span class="o">=</span> <span class="mf">0.9</span>
    <span class="n">min_v</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">max_v</span>

    <span class="n">tri_edges_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">min_v</span><span class="p">,</span> <span class="n">max_v</span><span class="p">,</span> <span class="n">n</span><span class="o">*</span><span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">max_v</span> <span class="o">-</span> <span class="mi">1</span><span class="o">/</span><span class="n">n</span><span class="p">,</span> <span class="n">min_v</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">)])</span>
    <span class="n">tri_edges_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">min_v</span><span class="p">,</span> <span class="n">max_v</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">max_v</span> <span class="o">-</span> <span class="mi">1</span><span class="o">/</span><span class="n">n</span><span class="p">,</span> <span class="n">min_v</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">min_v</span><span class="p">,</span> <span class="n">n</span><span class="p">)])</span>

    <span class="n">tri_edges_xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">([</span><span class="n">tri_edges_x</span><span class="p">,</span> <span class="n">tri_edges_y</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">],</span>
                  <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]])</span>

    <span class="n">bary_xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">T</span><span class="p">)</span> <span class="o">@</span> <span class="p">(</span><span class="n">tri_edges_xy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mf">1.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tri_edges_xy</span><span class="p">))])</span>
    <span class="n">bary_z</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bary_xy</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">rgb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">bary_xy</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">bary_xy</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">bary_z</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

    <span class="k">return</span> <span class="n">rgb</span>


<div class="viewcode-block" id="turbo_cmap"><a class="viewcode-back" href="../../viz.html#valis.viz.turbo_cmap">[docs]</a><span class="k">def</span> <span class="nf">turbo_cmap</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Turbo colormap</span>
<span class="sd">    https://gist.github.com/mikhailov-work/ee72ba4191942acecc03fe6da94fc73f</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># The look-up table contains 256 entries. Each entry is a floating point sRGB triplet.</span>
    <span class="c1"># To use it with matplotlib, pass cmap=ListedColormap(turbo_colormap_data) as an arg to imshow() (don&#39;t forget &quot;from matplotlib.colors import ListedColormap&quot;).</span>
    <span class="c1"># If you have a typical 8-bit greyscale image, you can use the 8-bit value to index into this LUT directly.</span>
    <span class="c1"># The floating point color values can be converted to 8-bit sRGB via multiplying by 255 and casting/flooring to an integer. Saturation should not be required for IEEE-754 compliant arithmetic.</span>
    <span class="c1"># If you have a floating point value in the range [0,1], you can use interpolate() to linearly interpolate between the entries.</span>
    <span class="c1"># If you have 16-bit or 32-bit integer values, convert them to floating point values on the [0,1] range and then use interpolate(). Doing the interpolation in floating point will reduce banding.</span>
    <span class="c1"># If some of your values may lie outside the [0,1] range, use interpolate_or_clip() to highlight them.</span>

    <span class="n">turbo_colormap_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.18995</span><span class="p">,</span> <span class="mf">0.07176</span><span class="p">,</span> <span class="mf">0.23217</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.19483</span><span class="p">,</span> <span class="mf">0.08339</span><span class="p">,</span> <span class="mf">0.26149</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.19956</span><span class="p">,</span> <span class="mf">0.09498</span><span class="p">,</span> <span class="mf">0.29024</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.20415</span><span class="p">,</span> <span class="mf">0.10652</span><span class="p">,</span> <span class="mf">0.31844</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.20860</span><span class="p">,</span> <span class="mf">0.11802</span><span class="p">,</span> <span class="mf">0.34607</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.21291</span><span class="p">,</span> <span class="mf">0.12947</span><span class="p">,</span> <span class="mf">0.37314</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.21708</span><span class="p">,</span> <span class="mf">0.14087</span><span class="p">,</span> <span class="mf">0.39964</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.22111</span><span class="p">,</span> <span class="mf">0.15223</span><span class="p">,</span> <span class="mf">0.42558</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.22500</span><span class="p">,</span> <span class="mf">0.16354</span><span class="p">,</span> <span class="mf">0.45096</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.22875</span><span class="p">,</span> <span class="mf">0.17481</span><span class="p">,</span> <span class="mf">0.47578</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.23236</span><span class="p">,</span> <span class="mf">0.18603</span><span class="p">,</span> <span class="mf">0.50004</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.23582</span><span class="p">,</span> <span class="mf">0.19720</span><span class="p">,</span> <span class="mf">0.52373</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.23915</span><span class="p">,</span> <span class="mf">0.20833</span><span class="p">,</span> <span class="mf">0.54686</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.24234</span><span class="p">,</span> <span class="mf">0.21941</span><span class="p">,</span> <span class="mf">0.56942</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.24539</span><span class="p">,</span> <span class="mf">0.23044</span><span class="p">,</span> <span class="mf">0.59142</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.24830</span><span class="p">,</span> <span class="mf">0.24143</span><span class="p">,</span> <span class="mf">0.61286</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.25107</span><span class="p">,</span> <span class="mf">0.25237</span><span class="p">,</span> <span class="mf">0.63374</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.25369</span><span class="p">,</span> <span class="mf">0.26327</span><span class="p">,</span> <span class="mf">0.65406</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.25618</span><span class="p">,</span> <span class="mf">0.27412</span><span class="p">,</span> <span class="mf">0.67381</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.25853</span><span class="p">,</span> <span class="mf">0.28492</span><span class="p">,</span> <span class="mf">0.69300</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.26074</span><span class="p">,</span> <span class="mf">0.29568</span><span class="p">,</span> <span class="mf">0.71162</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.26280</span><span class="p">,</span> <span class="mf">0.30639</span><span class="p">,</span> <span class="mf">0.72968</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.26473</span><span class="p">,</span> <span class="mf">0.31706</span><span class="p">,</span> <span class="mf">0.74718</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.26652</span><span class="p">,</span> <span class="mf">0.32768</span><span class="p">,</span> <span class="mf">0.76412</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.26816</span><span class="p">,</span> <span class="mf">0.33825</span><span class="p">,</span> <span class="mf">0.78050</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.26967</span><span class="p">,</span> <span class="mf">0.34878</span><span class="p">,</span> <span class="mf">0.79631</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.27103</span><span class="p">,</span> <span class="mf">0.35926</span><span class="p">,</span> <span class="mf">0.81156</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.27226</span><span class="p">,</span> <span class="mf">0.36970</span><span class="p">,</span> <span class="mf">0.82624</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.27334</span><span class="p">,</span> <span class="mf">0.38008</span><span class="p">,</span> <span class="mf">0.84037</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.27429</span><span class="p">,</span> <span class="mf">0.39043</span><span class="p">,</span> <span class="mf">0.85393</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.27509</span><span class="p">,</span> <span class="mf">0.40072</span><span class="p">,</span> <span class="mf">0.86692</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.27576</span><span class="p">,</span> <span class="mf">0.41097</span><span class="p">,</span> <span class="mf">0.87936</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.27628</span><span class="p">,</span> <span class="mf">0.42118</span><span class="p">,</span> <span class="mf">0.89123</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.27667</span><span class="p">,</span> <span class="mf">0.43134</span><span class="p">,</span> <span class="mf">0.90254</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.27691</span><span class="p">,</span> <span class="mf">0.44145</span><span class="p">,</span> <span class="mf">0.91328</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.27701</span><span class="p">,</span> <span class="mf">0.45152</span><span class="p">,</span> <span class="mf">0.92347</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.27698</span><span class="p">,</span> <span class="mf">0.46153</span><span class="p">,</span> <span class="mf">0.93309</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.27680</span><span class="p">,</span> <span class="mf">0.47151</span><span class="p">,</span> <span class="mf">0.94214</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.27648</span><span class="p">,</span> <span class="mf">0.48144</span><span class="p">,</span> <span class="mf">0.95064</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.27603</span><span class="p">,</span> <span class="mf">0.49132</span><span class="p">,</span> <span class="mf">0.95857</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.27543</span><span class="p">,</span> <span class="mf">0.50115</span><span class="p">,</span> <span class="mf">0.96594</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.27469</span><span class="p">,</span> <span class="mf">0.51094</span><span class="p">,</span> <span class="mf">0.97275</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.27381</span><span class="p">,</span> <span class="mf">0.52069</span><span class="p">,</span> <span class="mf">0.97899</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.27273</span><span class="p">,</span> <span class="mf">0.53040</span><span class="p">,</span> <span class="mf">0.98461</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.27106</span><span class="p">,</span> <span class="mf">0.54015</span><span class="p">,</span> <span class="mf">0.98930</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.26878</span><span class="p">,</span> <span class="mf">0.54995</span><span class="p">,</span> <span class="mf">0.99303</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.26592</span><span class="p">,</span> <span class="mf">0.55979</span><span class="p">,</span> <span class="mf">0.99583</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.26252</span><span class="p">,</span> <span class="mf">0.56967</span><span class="p">,</span> <span class="mf">0.99773</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.25862</span><span class="p">,</span> <span class="mf">0.57958</span><span class="p">,</span> <span class="mf">0.99876</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.25425</span><span class="p">,</span> <span class="mf">0.58950</span><span class="p">,</span> <span class="mf">0.99896</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.24946</span><span class="p">,</span> <span class="mf">0.59943</span><span class="p">,</span> <span class="mf">0.99835</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.24427</span><span class="p">,</span> <span class="mf">0.60937</span><span class="p">,</span> <span class="mf">0.99697</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.23874</span><span class="p">,</span> <span class="mf">0.61931</span><span class="p">,</span> <span class="mf">0.99485</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.23288</span><span class="p">,</span> <span class="mf">0.62923</span><span class="p">,</span> <span class="mf">0.99202</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.22676</span><span class="p">,</span> <span class="mf">0.63913</span><span class="p">,</span> <span class="mf">0.98851</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.22039</span><span class="p">,</span> <span class="mf">0.64901</span><span class="p">,</span> <span class="mf">0.98436</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.21382</span><span class="p">,</span> <span class="mf">0.65886</span><span class="p">,</span> <span class="mf">0.97959</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.20708</span><span class="p">,</span> <span class="mf">0.66866</span><span class="p">,</span> <span class="mf">0.97423</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.20021</span><span class="p">,</span> <span class="mf">0.67842</span><span class="p">,</span> <span class="mf">0.96833</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.19326</span><span class="p">,</span> <span class="mf">0.68812</span><span class="p">,</span> <span class="mf">0.96190</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.18625</span><span class="p">,</span> <span class="mf">0.69775</span><span class="p">,</span> <span class="mf">0.95498</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.17923</span><span class="p">,</span> <span class="mf">0.70732</span><span class="p">,</span> <span class="mf">0.94761</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.17223</span><span class="p">,</span> <span class="mf">0.71680</span><span class="p">,</span> <span class="mf">0.93981</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.16529</span><span class="p">,</span> <span class="mf">0.72620</span><span class="p">,</span> <span class="mf">0.93161</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.15844</span><span class="p">,</span> <span class="mf">0.73551</span><span class="p">,</span> <span class="mf">0.92305</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.15173</span><span class="p">,</span> <span class="mf">0.74472</span><span class="p">,</span> <span class="mf">0.91416</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.14519</span><span class="p">,</span> <span class="mf">0.75381</span><span class="p">,</span> <span class="mf">0.90496</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.13886</span><span class="p">,</span> <span class="mf">0.76279</span><span class="p">,</span> <span class="mf">0.89550</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.13278</span><span class="p">,</span> <span class="mf">0.77165</span><span class="p">,</span> <span class="mf">0.88580</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.12698</span><span class="p">,</span> <span class="mf">0.78037</span><span class="p">,</span> <span class="mf">0.87590</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.12151</span><span class="p">,</span> <span class="mf">0.78896</span><span class="p">,</span> <span class="mf">0.86581</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.11639</span><span class="p">,</span> <span class="mf">0.79740</span><span class="p">,</span> <span class="mf">0.85559</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.11167</span><span class="p">,</span> <span class="mf">0.80569</span><span class="p">,</span> <span class="mf">0.84525</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.10738</span><span class="p">,</span> <span class="mf">0.81381</span><span class="p">,</span> <span class="mf">0.83484</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.10357</span><span class="p">,</span> <span class="mf">0.82177</span><span class="p">,</span> <span class="mf">0.82437</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.10026</span><span class="p">,</span> <span class="mf">0.82955</span><span class="p">,</span> <span class="mf">0.81389</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.09750</span><span class="p">,</span> <span class="mf">0.83714</span><span class="p">,</span> <span class="mf">0.80342</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.09532</span><span class="p">,</span> <span class="mf">0.84455</span><span class="p">,</span> <span class="mf">0.79299</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.09377</span><span class="p">,</span> <span class="mf">0.85175</span><span class="p">,</span> <span class="mf">0.78264</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.09287</span><span class="p">,</span> <span class="mf">0.85875</span><span class="p">,</span> <span class="mf">0.77240</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.09267</span><span class="p">,</span> <span class="mf">0.86554</span><span class="p">,</span> <span class="mf">0.76230</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.09320</span><span class="p">,</span> <span class="mf">0.87211</span><span class="p">,</span> <span class="mf">0.75237</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.09451</span><span class="p">,</span> <span class="mf">0.87844</span><span class="p">,</span> <span class="mf">0.74265</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.09662</span><span class="p">,</span> <span class="mf">0.88454</span><span class="p">,</span> <span class="mf">0.73316</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.09958</span><span class="p">,</span> <span class="mf">0.89040</span><span class="p">,</span> <span class="mf">0.72393</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.10342</span><span class="p">,</span> <span class="mf">0.89600</span><span class="p">,</span> <span class="mf">0.71500</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.10815</span><span class="p">,</span> <span class="mf">0.90142</span><span class="p">,</span> <span class="mf">0.70599</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.11374</span><span class="p">,</span> <span class="mf">0.90673</span><span class="p">,</span> <span class="mf">0.69651</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.12014</span><span class="p">,</span> <span class="mf">0.91193</span><span class="p">,</span> <span class="mf">0.68660</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.12733</span><span class="p">,</span> <span class="mf">0.91701</span><span class="p">,</span> <span class="mf">0.67627</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.13526</span><span class="p">,</span> <span class="mf">0.92197</span><span class="p">,</span> <span class="mf">0.66556</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.14391</span><span class="p">,</span> <span class="mf">0.92680</span><span class="p">,</span> <span class="mf">0.65448</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.15323</span><span class="p">,</span> <span class="mf">0.93151</span><span class="p">,</span> <span class="mf">0.64308</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.16319</span><span class="p">,</span> <span class="mf">0.93609</span><span class="p">,</span> <span class="mf">0.63137</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.17377</span><span class="p">,</span> <span class="mf">0.94053</span><span class="p">,</span> <span class="mf">0.61938</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.18491</span><span class="p">,</span> <span class="mf">0.94484</span><span class="p">,</span> <span class="mf">0.60713</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.19659</span><span class="p">,</span> <span class="mf">0.94901</span><span class="p">,</span> <span class="mf">0.59466</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.20877</span><span class="p">,</span> <span class="mf">0.95304</span><span class="p">,</span> <span class="mf">0.58199</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.22142</span><span class="p">,</span> <span class="mf">0.95692</span><span class="p">,</span> <span class="mf">0.56914</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.23449</span><span class="p">,</span> <span class="mf">0.96065</span><span class="p">,</span> <span class="mf">0.55614</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.24797</span><span class="p">,</span> <span class="mf">0.96423</span><span class="p">,</span> <span class="mf">0.54303</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.26180</span><span class="p">,</span> <span class="mf">0.96765</span><span class="p">,</span> <span class="mf">0.52981</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.27597</span><span class="p">,</span> <span class="mf">0.97092</span><span class="p">,</span> <span class="mf">0.51653</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.29042</span><span class="p">,</span> <span class="mf">0.97403</span><span class="p">,</span> <span class="mf">0.50321</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.30513</span><span class="p">,</span> <span class="mf">0.97697</span><span class="p">,</span> <span class="mf">0.48987</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.32006</span><span class="p">,</span> <span class="mf">0.97974</span><span class="p">,</span> <span class="mf">0.47654</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.33517</span><span class="p">,</span> <span class="mf">0.98234</span><span class="p">,</span> <span class="mf">0.46325</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.35043</span><span class="p">,</span> <span class="mf">0.98477</span><span class="p">,</span> <span class="mf">0.45002</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.36581</span><span class="p">,</span> <span class="mf">0.98702</span><span class="p">,</span> <span class="mf">0.43688</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.38127</span><span class="p">,</span> <span class="mf">0.98909</span><span class="p">,</span> <span class="mf">0.42386</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.39678</span><span class="p">,</span> <span class="mf">0.99098</span><span class="p">,</span> <span class="mf">0.41098</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.41229</span><span class="p">,</span> <span class="mf">0.99268</span><span class="p">,</span> <span class="mf">0.39826</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.42778</span><span class="p">,</span> <span class="mf">0.99419</span><span class="p">,</span> <span class="mf">0.38575</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.44321</span><span class="p">,</span> <span class="mf">0.99551</span><span class="p">,</span> <span class="mf">0.37345</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.45854</span><span class="p">,</span> <span class="mf">0.99663</span><span class="p">,</span> <span class="mf">0.36140</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.47375</span><span class="p">,</span> <span class="mf">0.99755</span><span class="p">,</span> <span class="mf">0.34963</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.48879</span><span class="p">,</span> <span class="mf">0.99828</span><span class="p">,</span> <span class="mf">0.33816</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.50362</span><span class="p">,</span> <span class="mf">0.99879</span><span class="p">,</span> <span class="mf">0.32701</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.51822</span><span class="p">,</span> <span class="mf">0.99910</span><span class="p">,</span> <span class="mf">0.31622</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.53255</span><span class="p">,</span> <span class="mf">0.99919</span><span class="p">,</span> <span class="mf">0.30581</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.54658</span><span class="p">,</span> <span class="mf">0.99907</span><span class="p">,</span> <span class="mf">0.29581</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.56026</span><span class="p">,</span> <span class="mf">0.99873</span><span class="p">,</span> <span class="mf">0.28623</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.57357</span><span class="p">,</span> <span class="mf">0.99817</span><span class="p">,</span> <span class="mf">0.27712</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.58646</span><span class="p">,</span> <span class="mf">0.99739</span><span class="p">,</span> <span class="mf">0.26849</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.59891</span><span class="p">,</span> <span class="mf">0.99638</span><span class="p">,</span> <span class="mf">0.26038</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.61088</span><span class="p">,</span> <span class="mf">0.99514</span><span class="p">,</span> <span class="mf">0.25280</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.62233</span><span class="p">,</span> <span class="mf">0.99366</span><span class="p">,</span> <span class="mf">0.24579</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.63323</span><span class="p">,</span> <span class="mf">0.99195</span><span class="p">,</span> <span class="mf">0.23937</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.64362</span><span class="p">,</span> <span class="mf">0.98999</span><span class="p">,</span> <span class="mf">0.23356</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.65394</span><span class="p">,</span> <span class="mf">0.98775</span><span class="p">,</span> <span class="mf">0.22835</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.66428</span><span class="p">,</span> <span class="mf">0.98524</span><span class="p">,</span> <span class="mf">0.22370</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.67462</span><span class="p">,</span> <span class="mf">0.98246</span><span class="p">,</span> <span class="mf">0.21960</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.68494</span><span class="p">,</span> <span class="mf">0.97941</span><span class="p">,</span> <span class="mf">0.21602</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.69525</span><span class="p">,</span> <span class="mf">0.97610</span><span class="p">,</span> <span class="mf">0.21294</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.70553</span><span class="p">,</span> <span class="mf">0.97255</span><span class="p">,</span> <span class="mf">0.21032</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.71577</span><span class="p">,</span> <span class="mf">0.96875</span><span class="p">,</span> <span class="mf">0.20815</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.72596</span><span class="p">,</span> <span class="mf">0.96470</span><span class="p">,</span> <span class="mf">0.20640</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.73610</span><span class="p">,</span> <span class="mf">0.96043</span><span class="p">,</span> <span class="mf">0.20504</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.74617</span><span class="p">,</span> <span class="mf">0.95593</span><span class="p">,</span> <span class="mf">0.20406</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.75617</span><span class="p">,</span> <span class="mf">0.95121</span><span class="p">,</span> <span class="mf">0.20343</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.76608</span><span class="p">,</span> <span class="mf">0.94627</span><span class="p">,</span> <span class="mf">0.20311</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.77591</span><span class="p">,</span> <span class="mf">0.94113</span><span class="p">,</span> <span class="mf">0.20310</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.78563</span><span class="p">,</span> <span class="mf">0.93579</span><span class="p">,</span> <span class="mf">0.20336</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.79524</span><span class="p">,</span> <span class="mf">0.93025</span><span class="p">,</span> <span class="mf">0.20386</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.80473</span><span class="p">,</span> <span class="mf">0.92452</span><span class="p">,</span> <span class="mf">0.20459</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.81410</span><span class="p">,</span> <span class="mf">0.91861</span><span class="p">,</span> <span class="mf">0.20552</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.82333</span><span class="p">,</span> <span class="mf">0.91253</span><span class="p">,</span> <span class="mf">0.20663</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.83241</span><span class="p">,</span> <span class="mf">0.90627</span><span class="p">,</span> <span class="mf">0.20788</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.84133</span><span class="p">,</span> <span class="mf">0.89986</span><span class="p">,</span> <span class="mf">0.20926</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.85010</span><span class="p">,</span> <span class="mf">0.89328</span><span class="p">,</span> <span class="mf">0.21074</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.85868</span><span class="p">,</span> <span class="mf">0.88655</span><span class="p">,</span> <span class="mf">0.21230</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.86709</span><span class="p">,</span> <span class="mf">0.87968</span><span class="p">,</span> <span class="mf">0.21391</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.87530</span><span class="p">,</span> <span class="mf">0.87267</span><span class="p">,</span> <span class="mf">0.21555</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.88331</span><span class="p">,</span> <span class="mf">0.86553</span><span class="p">,</span> <span class="mf">0.21719</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.89112</span><span class="p">,</span> <span class="mf">0.85826</span><span class="p">,</span> <span class="mf">0.21880</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.89870</span><span class="p">,</span> <span class="mf">0.85087</span><span class="p">,</span> <span class="mf">0.22038</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.90605</span><span class="p">,</span> <span class="mf">0.84337</span><span class="p">,</span> <span class="mf">0.22188</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.91317</span><span class="p">,</span> <span class="mf">0.83576</span><span class="p">,</span> <span class="mf">0.22328</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.92004</span><span class="p">,</span> <span class="mf">0.82806</span><span class="p">,</span> <span class="mf">0.22456</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.92666</span><span class="p">,</span> <span class="mf">0.82025</span><span class="p">,</span> <span class="mf">0.22570</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.93301</span><span class="p">,</span> <span class="mf">0.81236</span><span class="p">,</span> <span class="mf">0.22667</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.93909</span><span class="p">,</span> <span class="mf">0.80439</span><span class="p">,</span> <span class="mf">0.22744</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.94489</span><span class="p">,</span> <span class="mf">0.79634</span><span class="p">,</span> <span class="mf">0.22800</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.95039</span><span class="p">,</span> <span class="mf">0.78823</span><span class="p">,</span> <span class="mf">0.22831</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.95560</span><span class="p">,</span> <span class="mf">0.78005</span><span class="p">,</span> <span class="mf">0.22836</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.96049</span><span class="p">,</span> <span class="mf">0.77181</span><span class="p">,</span> <span class="mf">0.22811</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.96507</span><span class="p">,</span> <span class="mf">0.76352</span><span class="p">,</span> <span class="mf">0.22754</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.96931</span><span class="p">,</span> <span class="mf">0.75519</span><span class="p">,</span> <span class="mf">0.22663</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.97323</span><span class="p">,</span> <span class="mf">0.74682</span><span class="p">,</span> <span class="mf">0.22536</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.97679</span><span class="p">,</span> <span class="mf">0.73842</span><span class="p">,</span> <span class="mf">0.22369</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.98000</span><span class="p">,</span> <span class="mf">0.73000</span><span class="p">,</span> <span class="mf">0.22161</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.98289</span><span class="p">,</span> <span class="mf">0.72140</span><span class="p">,</span> <span class="mf">0.21918</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.98549</span><span class="p">,</span> <span class="mf">0.71250</span><span class="p">,</span> <span class="mf">0.21650</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.98781</span><span class="p">,</span> <span class="mf">0.70330</span><span class="p">,</span> <span class="mf">0.21358</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.98986</span><span class="p">,</span> <span class="mf">0.69382</span><span class="p">,</span> <span class="mf">0.21043</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.99163</span><span class="p">,</span> <span class="mf">0.68408</span><span class="p">,</span> <span class="mf">0.20706</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.99314</span><span class="p">,</span> <span class="mf">0.67408</span><span class="p">,</span> <span class="mf">0.20348</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.99438</span><span class="p">,</span> <span class="mf">0.66386</span><span class="p">,</span> <span class="mf">0.19971</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.99535</span><span class="p">,</span> <span class="mf">0.65341</span><span class="p">,</span> <span class="mf">0.19577</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.99607</span><span class="p">,</span> <span class="mf">0.64277</span><span class="p">,</span> <span class="mf">0.19165</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.99654</span><span class="p">,</span> <span class="mf">0.63193</span><span class="p">,</span> <span class="mf">0.18738</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.99675</span><span class="p">,</span> <span class="mf">0.62093</span><span class="p">,</span> <span class="mf">0.18297</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.99672</span><span class="p">,</span> <span class="mf">0.60977</span><span class="p">,</span> <span class="mf">0.17842</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.99644</span><span class="p">,</span> <span class="mf">0.59846</span><span class="p">,</span> <span class="mf">0.17376</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.99593</span><span class="p">,</span> <span class="mf">0.58703</span><span class="p">,</span> <span class="mf">0.16899</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.99517</span><span class="p">,</span> <span class="mf">0.57549</span><span class="p">,</span> <span class="mf">0.16412</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.99419</span><span class="p">,</span> <span class="mf">0.56386</span><span class="p">,</span> <span class="mf">0.15918</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.99297</span><span class="p">,</span> <span class="mf">0.55214</span><span class="p">,</span> <span class="mf">0.15417</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.99153</span><span class="p">,</span> <span class="mf">0.54036</span><span class="p">,</span> <span class="mf">0.14910</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.98987</span><span class="p">,</span> <span class="mf">0.52854</span><span class="p">,</span> <span class="mf">0.14398</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.98799</span><span class="p">,</span> <span class="mf">0.51667</span><span class="p">,</span> <span class="mf">0.13883</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.98590</span><span class="p">,</span> <span class="mf">0.50479</span><span class="p">,</span> <span class="mf">0.13367</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.98360</span><span class="p">,</span> <span class="mf">0.49291</span><span class="p">,</span> <span class="mf">0.12849</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.98108</span><span class="p">,</span> <span class="mf">0.48104</span><span class="p">,</span> <span class="mf">0.12332</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.97837</span><span class="p">,</span> <span class="mf">0.46920</span><span class="p">,</span> <span class="mf">0.11817</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.97545</span><span class="p">,</span> <span class="mf">0.45740</span><span class="p">,</span> <span class="mf">0.11305</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.97234</span><span class="p">,</span> <span class="mf">0.44565</span><span class="p">,</span> <span class="mf">0.10797</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.96904</span><span class="p">,</span> <span class="mf">0.43399</span><span class="p">,</span> <span class="mf">0.10294</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.96555</span><span class="p">,</span> <span class="mf">0.42241</span><span class="p">,</span> <span class="mf">0.09798</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.96187</span><span class="p">,</span> <span class="mf">0.41093</span><span class="p">,</span> <span class="mf">0.09310</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.95801</span><span class="p">,</span> <span class="mf">0.39958</span><span class="p">,</span> <span class="mf">0.08831</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.95398</span><span class="p">,</span> <span class="mf">0.38836</span><span class="p">,</span> <span class="mf">0.08362</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.94977</span><span class="p">,</span> <span class="mf">0.37729</span><span class="p">,</span> <span class="mf">0.07905</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.94538</span><span class="p">,</span> <span class="mf">0.36638</span><span class="p">,</span> <span class="mf">0.07461</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.94084</span><span class="p">,</span> <span class="mf">0.35566</span><span class="p">,</span> <span class="mf">0.07031</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.93612</span><span class="p">,</span> <span class="mf">0.34513</span><span class="p">,</span> <span class="mf">0.06616</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.93125</span><span class="p">,</span> <span class="mf">0.33482</span><span class="p">,</span> <span class="mf">0.06218</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.92623</span><span class="p">,</span> <span class="mf">0.32473</span><span class="p">,</span> <span class="mf">0.05837</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.92105</span><span class="p">,</span> <span class="mf">0.31489</span><span class="p">,</span> <span class="mf">0.05475</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.91572</span><span class="p">,</span> <span class="mf">0.30530</span><span class="p">,</span> <span class="mf">0.05134</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.91024</span><span class="p">,</span> <span class="mf">0.29599</span><span class="p">,</span> <span class="mf">0.04814</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.90463</span><span class="p">,</span> <span class="mf">0.28696</span><span class="p">,</span> <span class="mf">0.04516</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.89888</span><span class="p">,</span> <span class="mf">0.27824</span><span class="p">,</span> <span class="mf">0.04243</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.89298</span><span class="p">,</span> <span class="mf">0.26981</span><span class="p">,</span> <span class="mf">0.03993</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.88691</span><span class="p">,</span> <span class="mf">0.26152</span><span class="p">,</span> <span class="mf">0.03753</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.88066</span><span class="p">,</span> <span class="mf">0.25334</span><span class="p">,</span> <span class="mf">0.03521</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.87422</span><span class="p">,</span> <span class="mf">0.24526</span><span class="p">,</span> <span class="mf">0.03297</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.86760</span><span class="p">,</span> <span class="mf">0.23730</span><span class="p">,</span> <span class="mf">0.03082</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.86079</span><span class="p">,</span> <span class="mf">0.22945</span><span class="p">,</span> <span class="mf">0.02875</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.85380</span><span class="p">,</span> <span class="mf">0.22170</span><span class="p">,</span> <span class="mf">0.02677</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.84662</span><span class="p">,</span> <span class="mf">0.21407</span><span class="p">,</span> <span class="mf">0.02487</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.83926</span><span class="p">,</span> <span class="mf">0.20654</span><span class="p">,</span> <span class="mf">0.02305</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.83172</span><span class="p">,</span> <span class="mf">0.19912</span><span class="p">,</span> <span class="mf">0.02131</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.82399</span><span class="p">,</span> <span class="mf">0.19182</span><span class="p">,</span> <span class="mf">0.01966</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.81608</span><span class="p">,</span> <span class="mf">0.18462</span><span class="p">,</span> <span class="mf">0.01809</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.80799</span><span class="p">,</span> <span class="mf">0.17753</span><span class="p">,</span> <span class="mf">0.01660</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.79971</span><span class="p">,</span> <span class="mf">0.17055</span><span class="p">,</span> <span class="mf">0.01520</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.79125</span><span class="p">,</span> <span class="mf">0.16368</span><span class="p">,</span> <span class="mf">0.01387</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.78260</span><span class="p">,</span> <span class="mf">0.15693</span><span class="p">,</span> <span class="mf">0.01264</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.77377</span><span class="p">,</span> <span class="mf">0.15028</span><span class="p">,</span> <span class="mf">0.01148</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.76476</span><span class="p">,</span> <span class="mf">0.14374</span><span class="p">,</span> <span class="mf">0.01041</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.75556</span><span class="p">,</span> <span class="mf">0.13731</span><span class="p">,</span> <span class="mf">0.00942</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.74617</span><span class="p">,</span> <span class="mf">0.13098</span><span class="p">,</span> <span class="mf">0.00851</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.73661</span><span class="p">,</span> <span class="mf">0.12477</span><span class="p">,</span> <span class="mf">0.00769</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.72686</span><span class="p">,</span> <span class="mf">0.11867</span><span class="p">,</span> <span class="mf">0.00695</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.71692</span><span class="p">,</span> <span class="mf">0.11268</span><span class="p">,</span> <span class="mf">0.00629</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.70680</span><span class="p">,</span> <span class="mf">0.10680</span><span class="p">,</span> <span class="mf">0.00571</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.69650</span><span class="p">,</span> <span class="mf">0.10102</span><span class="p">,</span> <span class="mf">0.00522</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.68602</span><span class="p">,</span> <span class="mf">0.09536</span><span class="p">,</span> <span class="mf">0.00481</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.67535</span><span class="p">,</span> <span class="mf">0.08980</span><span class="p">,</span> <span class="mf">0.00449</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.66449</span><span class="p">,</span> <span class="mf">0.08436</span><span class="p">,</span> <span class="mf">0.00424</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.65345</span><span class="p">,</span> <span class="mf">0.07902</span><span class="p">,</span> <span class="mf">0.00408</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.64223</span><span class="p">,</span> <span class="mf">0.07380</span><span class="p">,</span> <span class="mf">0.00401</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.63082</span><span class="p">,</span> <span class="mf">0.06868</span><span class="p">,</span> <span class="mf">0.00401</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.61923</span><span class="p">,</span> <span class="mf">0.06367</span><span class="p">,</span> <span class="mf">0.00410</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.60746</span><span class="p">,</span> <span class="mf">0.05878</span><span class="p">,</span> <span class="mf">0.00427</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.59550</span><span class="p">,</span> <span class="mf">0.05399</span><span class="p">,</span> <span class="mf">0.00453</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.58336</span><span class="p">,</span> <span class="mf">0.04931</span><span class="p">,</span> <span class="mf">0.00486</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.57103</span><span class="p">,</span> <span class="mf">0.04474</span><span class="p">,</span> <span class="mf">0.00529</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.55852</span><span class="p">,</span> <span class="mf">0.04028</span><span class="p">,</span> <span class="mf">0.00579</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.54583</span><span class="p">,</span> <span class="mf">0.03593</span><span class="p">,</span> <span class="mf">0.00638</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.53295</span><span class="p">,</span> <span class="mf">0.03169</span><span class="p">,</span> <span class="mf">0.00705</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.51989</span><span class="p">,</span> <span class="mf">0.02756</span><span class="p">,</span> <span class="mf">0.00780</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.50664</span><span class="p">,</span> <span class="mf">0.02354</span><span class="p">,</span> <span class="mf">0.00863</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.49321</span><span class="p">,</span> <span class="mf">0.01963</span><span class="p">,</span> <span class="mf">0.00955</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.47960</span><span class="p">,</span> <span class="mf">0.01583</span><span class="p">,</span> <span class="mf">0.01055</span><span class="p">]])</span>

    <span class="k">return</span> <span class="n">turbo_colormap_data</span></div>


<div class="viewcode-block" id="get_n_colors"><a class="viewcode-back" href="../../viz.html#valis.viz.get_n_colors">[docs]</a><span class="k">def</span> <span class="nf">get_n_colors</span><span class="p">(</span><span class="n">rgb</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Pick n most different colors in rgb. Differences based of rgb values in the CAM16UCS colorspace</span>
<span class="sd">    Based on https://larssonjohan.com/post/2016-10-30-farthest-points/</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">colour</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">suppress_warnings</span><span class="p">(</span><span class="n">colour_usage_warnings</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">rgb</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">255</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">rgb</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">):</span>
            <span class="n">cam</span> <span class="o">=</span> <span class="n">colour</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">rgb</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span> <span class="s1">&#39;sRGB&#39;</span><span class="p">,</span> <span class="s1">&#39;CAM16UCS&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cam</span> <span class="o">=</span> <span class="n">colour</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">rgb</span><span class="p">,</span> <span class="s1">&#39;sRGB&#39;</span><span class="p">,</span> <span class="s1">&#39;CAM16UCS&#39;</span><span class="p">)</span>

    <span class="n">sq_D</span> <span class="o">=</span> <span class="n">distance</span><span class="o">.</span><span class="n">cdist</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span> <span class="n">cam</span><span class="p">)</span>
    <span class="n">max_D</span> <span class="o">=</span> <span class="n">sq_D</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">most_dif_2Didx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sq_D</span> <span class="o">==</span> <span class="n">max_D</span><span class="p">)</span>  <span class="c1"># 2 most different colors</span>
    <span class="n">most_dif_img1</span> <span class="o">=</span> <span class="n">most_dif_2Didx</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">most_dif_img2</span> <span class="o">=</span> <span class="n">most_dif_2Didx</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">rgb_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">most_dif_img1</span><span class="p">,</span> <span class="n">most_dif_img2</span><span class="p">]</span>

    <span class="n">possible_idx</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">sq_D</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">possible_idx</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">most_dif_img1</span><span class="p">)</span>
    <span class="n">possible_idx</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">most_dif_img2</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">new_color</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="n">max_d_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">sq_D</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">rgb_idx</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">possible_idx</span><span class="p">])</span>
        <span class="n">new_rgb_idx</span> <span class="o">=</span> <span class="n">possible_idx</span><span class="p">[</span><span class="n">max_d_idx</span><span class="p">]</span>
        <span class="n">rgb_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_rgb_idx</span><span class="p">)</span>
        <span class="n">possible_idx</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">new_rgb_idx</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rgb</span><span class="p">[</span><span class="n">rgb_idx</span><span class="p">]</span></div>


<span class="nd">@nb</span><span class="o">.</span><span class="n">njit</span><span class="p">(</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">blend_colors</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">scale_by</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Color an image by blending</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    img : ndarray</span>
<span class="sd">        Image containing the raw data (float 32)</span>

<span class="sd">    colors : ndarray</span>
<span class="sd">        Colors for each channel in `img`</span>

<span class="sd">    scale_by : int</span>
<span class="sd">        How to scale each channel. &quot;image&quot; will scale the channel</span>
<span class="sd">        by the maximum value in the image. &quot;channel&quot; will scale</span>
<span class="sd">        the channel by the maximum in the channel</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    blended_img : ndarray</span>
<span class="sd">        A colored version of `img`</span>

<span class="sd">    &quot;&quot;&quot;</span>


    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">n_channel_colors</span> <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">n_channel_colors</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">nc</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nc</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">eps</span> <span class="o">=</span> <span class="mf">1.0000000000000001e-15</span>
    <span class="n">sum_img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">eps</span>
    <span class="k">if</span> <span class="n">scale_by</span> <span class="o">==</span> <span class="s2">&quot;image&quot;</span><span class="p">:</span>
        <span class="n">img_max</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="n">blended_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">n_channel_colors</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nc</span><span class="p">):</span>
        <span class="c1"># relative image is how bright the channel will be</span>
        <span class="k">if</span> <span class="n">scale_by</span> <span class="o">!=</span> <span class="s2">&quot;image&quot;</span><span class="p">:</span>
            <span class="n">channel_max</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">relative_img</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">channel_max</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">relative_img</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">img_max</span>

        <span class="c1"># blending is how to weight the mix of colors, similar to an alpha channel</span>
        <span class="n">blending</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">sum_img</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">colors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">channel_color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
            <span class="n">blended_img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">channel_color</span> <span class="o">*</span> <span class="n">relative_img</span> <span class="o">*</span> <span class="n">blending</span>

    <span class="k">return</span> <span class="n">blended_img</span>


<div class="viewcode-block" id="color_multichannel"><a class="viewcode-back" href="../../viz.html#valis.viz.color_multichannel">[docs]</a><span class="k">def</span> <span class="nf">color_multichannel</span><span class="p">(</span><span class="n">multichannel_img</span><span class="p">,</span> <span class="n">marker_colors</span><span class="p">,</span> <span class="n">rescale_channels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">normalize_by</span><span class="o">=</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="n">cspace</span><span class="o">=</span><span class="s2">&quot;Hunter Lab&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Color a multichannel image to view as RGB</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    multichannel_img : ndarray</span>
<span class="sd">        Image to color</span>

<span class="sd">    marker_colors : ndarray</span>
<span class="sd">        sRGB colors for each channel.</span>

<span class="sd">    rescale_channels : bool</span>
<span class="sd">        If True, then each channel will be scaled between 0 and 1 before</span>
<span class="sd">        building the composite RGB image. This will allow markers to &#39;pop&#39;</span>
<span class="sd">        in areas where they are expressed in isolation, but can also make</span>
<span class="sd">        it appear more marker is expressed than there really is.</span>

<span class="sd">    normalize_by : str, optionaal</span>
<span class="sd">        &quot;image&quot; will produce an image where all values are scaled between</span>
<span class="sd">        0 and the highest intensity in the composite image. This will produce</span>
<span class="sd">        an image where one can see the expression of each marker relative to</span>
<span class="sd">        the others, making it easier to compare marker expression levels.</span>

<span class="sd">        &quot;channel&quot; will first scale the intensity of each channel, and then</span>
<span class="sd">        blend all of the channels together. This will allow one to see the</span>
<span class="sd">        relative expression of each marker, but won&#39;t allow one to directly</span>
<span class="sd">        compare the expression of markers across channels.</span>

<span class="sd">    cspace : str</span>
<span class="sd">        Colorspace in which `marker_colors` will be blended.</span>
<span class="sd">        JzAzBz, Hunter Lab, and sRGB all work well. But, see</span>
<span class="sd">        colour.COLOURSPACE_MODELS for other possible colorspaces</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    rgb : ndarray</span>
<span class="sd">        An sRGB version of `multichannel_img`</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">rescale_channels</span><span class="p">:</span>
        <span class="n">multichannel_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">([</span><span class="n">exposure</span><span class="o">.</span><span class="n">rescale_intensity</span><span class="p">(</span><span class="n">multichannel_img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">),</span> <span class="n">in_range</span><span class="o">=</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="n">out_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">multichannel_img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])])</span>

    <span class="n">is_srgb</span> <span class="o">=</span> <span class="n">cspace</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;srgb&quot;</span>
    <span class="n">is_srgb_01</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">marker_colors</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">255</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">marker_colors</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">):</span>
        <span class="n">srgb_01</span> <span class="o">=</span> <span class="n">marker_colors</span><span class="o">/</span><span class="mi">255</span>
        <span class="n">is_srgb_01</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">srgb_01</span> <span class="o">=</span> <span class="n">marker_colors</span>
    <span class="n">eps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="s2">&quot;float&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_srgb</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">colour</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">suppress_warnings</span><span class="p">(</span><span class="n">colour_usage_warnings</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">cspace_colors</span> <span class="o">=</span> <span class="n">colour</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">srgb_01</span> <span class="o">+</span> <span class="n">eps</span><span class="p">,</span> <span class="s1">&#39;sRGB&#39;</span><span class="p">,</span> <span class="n">cspace</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cspace_colors</span> <span class="o">=</span> <span class="n">srgb_01</span>

    <span class="n">blended_img</span> <span class="o">=</span> <span class="n">blend_colors</span><span class="p">(</span><span class="n">multichannel_img</span><span class="p">,</span> <span class="n">cspace_colors</span><span class="p">,</span> <span class="n">normalize_by</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_srgb</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">colour</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">suppress_warnings</span><span class="p">(</span><span class="n">colour_usage_warnings</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">srgb_blended</span> <span class="o">=</span> <span class="n">colour</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">blended_img</span> <span class="o">+</span> <span class="n">eps</span><span class="p">,</span> <span class="n">cspace</span><span class="p">,</span> <span class="s1">&#39;sRGB&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">eps</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">srgb_blended</span> <span class="o">=</span> <span class="n">blended_img</span>

    <span class="n">srgb_blended</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">srgb_blended</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_srgb_01</span><span class="p">:</span>
        <span class="n">srgb_blended</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span> <span class="o">*</span> <span class="n">srgb_blended</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">marker_colors</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">srgb_blended</span></div>


<div class="viewcode-block" id="color_dxdy"><a class="viewcode-back" href="../../viz.html#valis.viz.color_dxdy">[docs]</a><span class="k">def</span> <span class="nf">color_dxdy</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">c_range</span><span class="o">=</span><span class="n">DXDY_CRANGE</span><span class="p">,</span> <span class="n">l_range</span><span class="o">=</span><span class="n">DXDY_LRANGE</span><span class="p">,</span> <span class="n">cspace</span><span class="o">=</span><span class="n">DXDY_CSPACE</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Color displacement, where larger displacements are more colorful,</span>
<span class="sd">   and, if scale_l=True,  brighter.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dx: array</span>
<span class="sd">        1D Array containing the displacement in the X (column) direction</span>

<span class="sd">    dy: array</span>
<span class="sd">        1D Array containing the displacement in the Y (row) direction</span>

<span class="sd">    c_range: (float, float)</span>
<span class="sd">        Minimum and maximum colorfulness in JzAzBz colorspace</span>

<span class="sd">    l_range: (float, float)</span>
<span class="sd">        Minimum and maximum luminosity in JzAzBz colorspace</span>

<span class="sd">    scale_l: boolean</span>
<span class="sd">        Scale the luminosity based on magnitude of displacement</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    displacement_rgb : array</span>
<span class="sd">        RGB (0, 255) color for each displacement, with the same shape as dx and dy</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">initial_shape</span> <span class="o">=</span> <span class="n">dx</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">dx</span> <span class="o">=</span> <span class="n">dx</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">dy</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">dx</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">dy</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
        <span class="c1"># No displacements. Return grey image</span>
        <span class="k">with</span> <span class="n">colour</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">suppress_warnings</span><span class="p">(</span><span class="n">colour_usage_warnings</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">bg_rgb</span> <span class="o">=</span> <span class="n">colour</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">([</span><span class="n">l_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">cspace</span><span class="p">,</span> <span class="s1">&#39;sRGB&#39;</span><span class="p">)</span><span class="o">*</span><span class="mi">255</span>

        <span class="n">displacement_rgb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="o">*</span><span class="n">initial_shape</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">bg_rgb</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">displacement_rgb</span>

    <span class="n">eps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="s2">&quot;float&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span>
    <span class="n">magnitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dx</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">dy</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">eps</span><span class="p">)</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">exposure</span><span class="o">.</span><span class="n">rescale_intensity</span><span class="p">(</span><span class="n">magnitude</span><span class="p">,</span> <span class="n">in_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">magnitude</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span> <span class="n">out_range</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">c_range</span><span class="p">))</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">dy</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">dx</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">A</span><span class="p">,</span> <span class="n">B</span> <span class="o">=</span> <span class="n">C</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">H</span><span class="p">),</span> <span class="n">C</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>
    <span class="n">J</span> <span class="o">=</span> <span class="n">exposure</span><span class="o">.</span><span class="n">rescale_intensity</span><span class="p">(</span><span class="n">magnitude</span><span class="p">,</span> <span class="n">in_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">magnitude</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span> <span class="n">out_range</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">l_range</span><span class="p">))</span>

    <span class="k">with</span> <span class="n">colour</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">suppress_warnings</span><span class="p">(</span><span class="n">colour_usage_warnings</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">rgb</span> <span class="o">=</span> <span class="n">colour</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">([</span><span class="n">J</span><span class="p">,</span> <span class="n">A</span><span class="o">+</span><span class="n">eps</span><span class="p">,</span> <span class="n">B</span><span class="o">+</span><span class="n">eps</span><span class="p">]),</span> <span class="n">cspace</span><span class="p">,</span> <span class="s1">&#39;sRGB&#39;</span><span class="p">)</span>

    <span class="n">displacement_rgb</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">rgb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">*</span><span class="n">initial_shape</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">displacement_rgb</span></div>


<span class="k">def</span> <span class="nf">displacement_legend</span><span class="p">():</span>

    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

    <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">X</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">Y</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>

    <span class="n">C</span> <span class="o">=</span> <span class="n">exposure</span><span class="o">.</span><span class="n">rescale_intensity</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">out_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="n">grad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">grad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">grad</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">grad</span><span class="o">*</span><span class="n">C</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">grad</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">C</span>

    <span class="n">displacement_legend</span> <span class="o">=</span> <span class="n">color_dxdy</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">DXDY_CRANGE</span><span class="p">,</span> <span class="n">DXDY_LRANGE</span><span class="p">,</span> <span class="n">cspace</span><span class="o">=</span><span class="n">DXDY_CSPACE</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">displacement_legend</span>


<span class="k">def</span> <span class="nf">draw_displacement_legend</span><span class="p">():</span>
    <span class="n">leg</span> <span class="o">=</span> <span class="n">displacement_legend</span><span class="p">()</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">locator_params</span><span class="p">(</span><span class="n">nbins</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">leg</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;dx&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;dy&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="color_displacement_grid"><a class="viewcode-back" href="../../viz.html#valis.viz.color_displacement_grid">[docs]</a><span class="k">def</span> <span class="nf">color_displacement_grid</span><span class="p">(</span><span class="n">bk_dx</span><span class="p">,</span> <span class="n">bk_dy</span><span class="p">,</span> <span class="n">c_range</span><span class="o">=</span><span class="n">DXDY_CRANGE</span><span class="p">,</span> <span class="n">l_range</span><span class="o">=</span><span class="n">DXDY_LRANGE</span><span class="p">,</span> <span class="n">thickness</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">grid_spacing_ratio</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">cspace</span><span class="o">=</span><span class="n">DXDY_CSPACE</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Color a displacement grid</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">grid_spacing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bk_dx</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">*</span><span class="n">grid_spacing_ratio</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">min_dim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">bk_dx</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">thickness</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">thickness</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">grid_spacing</span><span class="o">/</span><span class="n">min_dim</span><span class="p">)</span><span class="o">*</span><span class="mi">15</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">thickness</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">thickness</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">grid_r</span><span class="p">,</span> <span class="n">grid_c</span> <span class="o">=</span> <span class="n">get_grid</span><span class="p">(</span><span class="n">bk_dx</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">grid_spacing</span><span class="p">,</span> <span class="n">thickness</span><span class="p">)</span>
    <span class="n">grid_colors</span> <span class="o">=</span> <span class="n">color_dxdy</span><span class="p">(</span><span class="n">bk_dx</span><span class="p">[</span><span class="n">grid_r</span><span class="p">,</span> <span class="n">grid_c</span><span class="p">],</span> <span class="n">bk_dy</span><span class="p">[</span><span class="n">grid_r</span><span class="p">,</span> <span class="n">grid_c</span><span class="p">],</span>  <span class="n">c_range</span><span class="o">=</span><span class="n">c_range</span><span class="p">,</span> <span class="n">l_range</span><span class="o">=</span><span class="n">l_range</span><span class="p">,</span> <span class="n">cspace</span><span class="o">=</span><span class="n">cspace</span><span class="p">)</span>

    <span class="c1"># Warp image of grid</span>
    <span class="n">grid_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="o">*</span><span class="n">bk_dx</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">grid_img</span><span class="p">[</span><span class="n">grid_r</span><span class="p">,</span> <span class="n">grid_c</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid_colors</span>

    <span class="n">img_r</span><span class="p">,</span> <span class="n">img_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="n">bk_dx</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">img_warp_r</span> <span class="o">=</span> <span class="n">img_r</span> <span class="o">+</span> <span class="n">bk_dy</span><span class="p">[</span><span class="n">img_r</span><span class="p">,</span> <span class="n">img_c</span><span class="p">]</span>
    <span class="n">img_warp_c</span> <span class="o">=</span> <span class="n">img_c</span> <span class="o">+</span> <span class="n">bk_dx</span><span class="p">[</span><span class="n">img_r</span><span class="p">,</span> <span class="n">img_c</span><span class="p">]</span>

    <span class="n">img_warp_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">img_warp_r</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bk_dx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">img_warp_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">img_warp_c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bk_dx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">warped_hcl</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">warped_hcl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">warp</span><span class="p">(</span><span class="n">grid_img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">img_warp_r</span><span class="p">,</span> <span class="n">img_warp_c</span><span class="p">]))</span>

    <span class="n">grid_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">(</span><span class="n">warped_hcl</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">grid_img</span></div>


<span class="k">def</span> <span class="nf">draw_trimesh</span><span class="p">(</span><span class="n">shape_rc</span><span class="p">,</span> <span class="n">tri_verts</span><span class="p">,</span> <span class="n">tri_faces</span><span class="p">,</span> <span class="n">thickness</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Draw a triangular mesh</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">tri_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape_rc</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">face</span> <span class="ow">in</span> <span class="n">tri_faces</span><span class="p">:</span>
        <span class="n">verts</span> <span class="o">=</span> <span class="n">tri_verts</span><span class="p">[</span><span class="n">face</span><span class="p">]</span>
        <span class="c1"># make sure points are clockwise</span>
        <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">verts</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">pt_order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">cy</span><span class="p">,</span> <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">cx</span><span class="p">))</span>
                               <span class="k">for</span> <span class="n">xy</span> <span class="ow">in</span> <span class="n">verts</span><span class="p">])</span>
        <span class="c1"># draw points</span>
        <span class="n">pts</span> <span class="o">=</span> <span class="n">verts</span><span class="p">[</span><span class="n">pt_order</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">tri_img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">polylines</span><span class="p">(</span><span class="n">tri_img</span><span class="p">,</span> <span class="p">[</span><span class="n">pts</span><span class="p">],</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">thickness</span><span class="p">,</span>
                                <span class="n">lineType</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">LINE_AA</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tri_img</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>



<div class="viewcode-block" id="color_displacement_tri_grid"><a class="viewcode-back" href="../../viz.html#valis.viz.color_displacement_tri_grid">[docs]</a><span class="k">def</span> <span class="nf">color_displacement_tri_grid</span><span class="p">(</span><span class="n">bk_dx</span><span class="p">,</span> <span class="n">bk_dy</span><span class="p">,</span> <span class="n">img</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_grid_pts</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">c_range</span><span class="o">=</span><span class="n">DXDY_CRANGE</span><span class="p">,</span> <span class="n">l_range</span><span class="o">=</span><span class="n">DXDY_LRANGE</span><span class="p">,</span> <span class="n">thickness</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cspace</span><span class="o">=</span><span class="n">DXDY_CSPACE</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;View how a displacement warps a triangular mesh.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bk_dx</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">grid_spacing</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">shape</span><span class="o">/</span><span class="n">n_grid_pts</span><span class="p">)))</span>

    <span class="n">new_r</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">%</span> <span class="n">grid_spacing</span> <span class="o">+</span> <span class="n">grid_spacing</span>
    <span class="n">sample_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">new_r</span> <span class="o">+</span> <span class="n">grid_spacing</span><span class="p">,</span> <span class="n">grid_spacing</span><span class="p">)</span>

    <span class="n">new_c</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">%</span> <span class="n">grid_spacing</span> <span class="o">+</span> <span class="n">grid_spacing</span>
    <span class="n">sample_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">new_c</span> <span class="o">+</span> <span class="n">grid_spacing</span><span class="p">,</span> <span class="n">grid_spacing</span><span class="p">)</span>

    <span class="n">padded_shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">new_r</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">new_c</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">padding_T</span> <span class="o">=</span> <span class="n">warp_tools</span><span class="o">.</span><span class="n">get_padding_matrix</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">padded_shape</span><span class="p">)</span>

    <span class="n">padded_dx</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">warp</span><span class="p">(</span><span class="n">bk_dx</span><span class="p">,</span> <span class="n">padding_T</span><span class="p">,</span> <span class="n">output_shape</span><span class="o">=</span><span class="n">padded_shape</span><span class="p">,</span> <span class="n">preserve_range</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">padded_dy</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">warp</span><span class="p">(</span><span class="n">bk_dy</span><span class="p">,</span> <span class="n">padding_T</span><span class="p">,</span> <span class="n">output_shape</span><span class="o">=</span><span class="n">padded_shape</span><span class="p">,</span> <span class="n">preserve_range</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">min_dim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">padded_dy</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">thickness</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">thickness</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">grid_spacing</span><span class="o">/</span><span class="n">min_dim</span><span class="p">)</span><span class="o">*</span><span class="mi">15</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">thickness</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">thickness</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">tri_verts</span><span class="p">,</span> <span class="n">tri_faces</span> <span class="o">=</span> <span class="n">warp_tools</span><span class="o">.</span><span class="n">get_triangular_mesh</span><span class="p">(</span><span class="n">sample_x</span><span class="p">,</span> <span class="n">sample_y</span><span class="p">)</span>
    <span class="n">warped_xy</span> <span class="o">=</span> <span class="n">warp_tools</span><span class="o">.</span><span class="n">warp_xy</span><span class="p">(</span><span class="n">tri_verts</span><span class="p">,</span> <span class="n">bk_dxdy</span><span class="o">=</span><span class="p">[</span><span class="n">padded_dx</span><span class="p">,</span> <span class="n">padded_dy</span><span class="p">])</span>

    <span class="n">inv_T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">padding_T</span><span class="p">)</span>
    <span class="n">trimesh_img</span> <span class="o">=</span> <span class="n">draw_trimesh</span><span class="p">(</span><span class="n">padded_shape</span><span class="p">,</span> <span class="n">warped_xy</span><span class="p">,</span> <span class="n">tri_faces</span><span class="p">,</span> <span class="n">thickness</span><span class="o">=</span><span class="n">thickness</span><span class="p">)</span>
    <span class="n">trimesh_img</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">warp</span><span class="p">(</span><span class="n">trimesh_img</span><span class="p">,</span> <span class="n">inv_T</span><span class="p">,</span> <span class="n">output_shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">preserve_range</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">colored_displacement</span> <span class="o">=</span> <span class="n">color_dxdy</span><span class="p">(</span><span class="n">bk_dx</span><span class="p">,</span> <span class="n">bk_dy</span><span class="p">,</span> <span class="n">c_range</span><span class="o">=</span><span class="n">c_range</span><span class="p">,</span> <span class="n">l_range</span><span class="o">=</span><span class="n">l_range</span><span class="p">,</span> <span class="n">cspace</span><span class="o">=</span><span class="n">cspace</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">img</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">trimesh_img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;mismatch in shape between `img` </span><span class="si">{</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2"> and displacement fields </span><span class="si">{</span><span class="n">trimesh_img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">mesh_pos</span> <span class="o">=</span> <span class="n">trimesh_img</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">out_img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">out_img</span><span class="p">[</span><span class="n">mesh_pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">colored_displacement</span><span class="p">[</span><span class="n">mesh_pos</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">out_img</span> <span class="o">=</span> <span class="n">trimesh_img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">colored_displacement</span>

    <span class="k">return</span> <span class="n">out_img</span></div>

</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2022, Chandler Gatenbee.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>