

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>valis.serial_non_rigid &mdash; valis &#34;1.0.0rc11&#34;
 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: black" >
          

          
            <a href="../../index.html">
          

          
            
            <img src="../../_static/valis_logo_black_no_bg.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../registration.html">Registration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../slide_io.html">Slide I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../preprocessing.html">Image pre-processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../feature_detectors.html">Feature detectors and descriptors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../feature_matcher.html">Feature matching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../affine_optimizer.html">Affine optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../non_rigid_registrars.html">Non-rigid registration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../serial_rigid.html">Serial rigid registration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../serial_non_rigid.html">Serial non-rigid registration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../viz.html">Visualization</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">valis</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>valis.serial_non_rigid</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for valis.serial_non_rigid</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Classes and functions to perform serial non-rigid registration of a set of images</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="n">io</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">imghdr</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">pyvips</span>
<span class="kn">import</span> <span class="nn">inspect</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">warp_tools</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">non_rigid_registrars</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">valtils</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">serial_rigid</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">viz</span>

<span class="n">IMG_LIST_KEY</span> <span class="o">=</span> <span class="s2">&quot;img_list&quot;</span>
<span class="n">IMG_F_LIST_KEY</span> <span class="o">=</span> <span class="s2">&quot;img_f_list&quot;</span>
<span class="n">IMG_NAME_KEY</span> <span class="o">=</span> <span class="s2">&quot;name_list&quot;</span>
<span class="n">MASK_LIST_KEY</span> <span class="o">=</span> <span class="s2">&quot;mask_list&quot;</span>

<span class="k">def</span> <span class="nf">get_matching_xy_from_rigid_registrar</span><span class="p">(</span><span class="n">rigid_registrar</span><span class="p">,</span> <span class="n">ref_img_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get matching keypoints to use in serial non-rigid registration</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rigid_registrar : SerialRigidRegistrar</span>
<span class="sd">        SerialRigidRegistrar that has aligned a series of images</span>

<span class="sd">    ref_img_name : str, optional</span>
<span class="sd">        Name of image that will be treated as the center of the stack.</span>
<span class="sd">        If None, the middle image will be used as the center</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    from_to_kp_dict : dict of list</span>
<span class="sd">        Key = image name, value = list of matched and aligned keypoints between</span>
<span class="sd">        each registered moving image and the registered fixed image.</span>
<span class="sd">        Each element in the list contains 2 arrays:</span>

<span class="sd">        #. Rigid registered xy in moving/current/from image</span>
<span class="sd">        #. Rigid registered xy in fixed/next/to image</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">img_f_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">img_obj</span><span class="o">.</span><span class="n">full_img_f</span> <span class="k">for</span> <span class="n">img_obj</span> <span class="ow">in</span> <span class="n">rigid_registrar</span><span class="o">.</span><span class="n">img_obj_list</span><span class="p">]</span>
    <span class="n">ref_img_idx</span> <span class="o">=</span> <span class="n">warp_tools</span><span class="o">.</span><span class="n">get_ref_img_idx</span><span class="p">(</span><span class="n">img_f_list</span><span class="p">,</span> <span class="n">ref_img_name</span><span class="p">)</span>
    <span class="n">n_imgs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">img_f_list</span><span class="p">)</span>

    <span class="n">from_to_indices</span> <span class="o">=</span> <span class="n">warp_tools</span><span class="o">.</span><span class="n">get_alignment_indices</span><span class="p">(</span><span class="n">n_imgs</span><span class="p">,</span> <span class="n">ref_img_idx</span><span class="p">)</span>
    <span class="n">from_to_kp_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">from_to_indices</span><span class="p">:</span>

        <span class="n">moving_obj</span> <span class="o">=</span> <span class="n">rigid_registrar</span><span class="o">.</span><span class="n">img_obj_list</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">fixed_obj</span> <span class="o">=</span> <span class="n">rigid_registrar</span><span class="o">.</span><span class="n">img_obj_list</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

        <span class="n">current_match_dict</span> <span class="o">=</span> <span class="n">moving_obj</span><span class="o">.</span><span class="n">match_dict</span><span class="p">[</span><span class="n">fixed_obj</span><span class="p">]</span>
        <span class="n">moving_kp</span> <span class="o">=</span> <span class="n">current_match_dict</span><span class="o">.</span><span class="n">matched_kp1_xy</span>
        <span class="n">fixed_kp</span> <span class="o">=</span> <span class="n">current_match_dict</span><span class="o">.</span><span class="n">matched_kp2_xy</span>

        <span class="k">assert</span> <span class="n">moving_kp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">fixed_kp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">registered_moving</span> <span class="o">=</span> <span class="n">warp_tools</span><span class="o">.</span><span class="n">warp_xy</span><span class="p">(</span><span class="n">moving_kp</span><span class="p">,</span> <span class="n">M</span><span class="o">=</span><span class="n">moving_obj</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>
        <span class="n">registered_fixed</span> <span class="o">=</span> <span class="n">warp_tools</span><span class="o">.</span><span class="n">warp_xy</span><span class="p">(</span><span class="n">fixed_kp</span><span class="p">,</span> <span class="n">M</span><span class="o">=</span><span class="n">fixed_obj</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>

        <span class="n">from_to_kp_dict</span><span class="p">[</span><span class="n">moving_obj</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">registered_moving</span><span class="p">,</span> <span class="n">registered_fixed</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">from_to_kp_dict</span>


<span class="k">def</span> <span class="nf">get_imgs_from_dir</span><span class="p">(</span><span class="n">src_dir</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get images from source directory.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src_dir : str</span>
<span class="sd">        Location of images to be registered.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    img_list : list of ndarray</span>
<span class="sd">        List of images to be registered</span>

<span class="sd">    img_f_list : list of str</span>
<span class="sd">        List of image file names</span>

<span class="sd">    img_names : list of str</span>
<span class="sd">        List of names for each image. Created by removing the extension</span>

<span class="sd">    mask_list : list of ndarray</span>
<span class="sd">        List of masks used for registration</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">img_f_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">src_dir</span><span class="p">)</span> <span class="k">if</span>
                  <span class="n">imghdr</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src_dir</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>

    <span class="n">valtils</span><span class="o">.</span><span class="n">sort_nicely</span><span class="p">(</span><span class="n">img_f_list</span><span class="p">)</span>

    <span class="n">img_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">io</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src_dir</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">img_f_list</span><span class="p">]</span>

    <span class="n">img_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">valtils</span><span class="o">.</span><span class="n">get_name</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">img_f_list</span><span class="p">]</span>

    <span class="n">mask_list</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">img_f_list</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">img_list</span><span class="p">,</span> <span class="n">img_f_list</span><span class="p">,</span> <span class="n">img_names</span><span class="p">,</span> <span class="n">mask_list</span>


<span class="k">def</span> <span class="nf">get_imgs_rigid_reg</span><span class="p">(</span><span class="n">serial_rigid_reg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get images from SerialRigidRegistrar</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    serial_rigid_reg : SerialRigidRegistrar</span>
<span class="sd">        SerialRigidRegistrar that has rigidly aligned images</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    img_list : list of ndarray</span>
<span class="sd">        List of images to be registered</span>

<span class="sd">    img_f_list : list of str</span>
<span class="sd">        List of image file names</span>

<span class="sd">    img_names : list of str</span>
<span class="sd">        List of names for each image. Created by removing the extension</span>

<span class="sd">    mask_list : list of ndarray</span>
<span class="sd">        List of masks used for registration</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">img_list</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">serial_rigid_reg</span><span class="o">.</span><span class="n">size</span>
    <span class="n">img_names</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">serial_rigid_reg</span><span class="o">.</span><span class="n">size</span>
    <span class="n">img_f_list</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">serial_rigid_reg</span><span class="o">.</span><span class="n">size</span>
    <span class="n">mask_list</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">serial_rigid_reg</span><span class="o">.</span><span class="n">size</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">img_obj</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">serial_rigid_reg</span><span class="o">.</span><span class="n">img_obj_list</span><span class="p">):</span>
        <span class="n">img_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">img_obj</span><span class="o">.</span><span class="n">registered_img</span>
        <span class="n">img_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">img_obj</span><span class="o">.</span><span class="n">name</span>
        <span class="n">img_f_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">img_obj</span><span class="o">.</span><span class="n">full_img_f</span>

        <span class="c1"># Moving mask</span>
        <span class="n">temp_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">img_obj</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
        <span class="n">img_mask</span> <span class="o">=</span> <span class="n">warp_tools</span><span class="o">.</span><span class="n">warp_img</span><span class="p">(</span><span class="n">temp_mask</span><span class="p">,</span> <span class="n">M</span><span class="o">=</span><span class="n">img_obj</span><span class="o">.</span><span class="n">M</span><span class="p">,</span>
                                       <span class="n">out_shape_rc</span><span class="o">=</span><span class="n">img_obj</span><span class="o">.</span><span class="n">registered_img</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">mask_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">img_mask</span>

    <span class="k">return</span> <span class="n">img_list</span><span class="p">,</span> <span class="n">img_f_list</span><span class="p">,</span> <span class="n">img_names</span><span class="p">,</span> <span class="n">mask_list</span>


<span class="k">def</span> <span class="nf">get_imgs_from_dict</span><span class="p">(</span><span class="n">img_dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get images from source directory.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    img_dict : dictionary</span>
<span class="sd">        Dictionary containing the following key : value pairs</span>

<span class="sd">        &quot;img_list&quot; : list of images to register</span>
<span class="sd">        &quot;img_f_list&quot; : list of filenames of each image</span>
<span class="sd">        &quot;name_list&quot; : list of image names. If not provided, will come from file names</span>
<span class="sd">        &quot;mask_list&quot; list of masks for each image</span>

<span class="sd">    All of the above are optional, except `img_list`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    img_list : list of ndarray</span>
<span class="sd">        List of images to be registered</span>

<span class="sd">    img_f_list : list of str</span>
<span class="sd">        List of image file names</span>

<span class="sd">    img_names : list of str</span>
<span class="sd">        List of names for each image. Created by removing the extension</span>

<span class="sd">    mask_list : list of ndarray</span>
<span class="sd">        List of masks used for registration</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">img_list</span> <span class="o">=</span> <span class="n">img_dict</span><span class="p">[</span><span class="n">IMG_LIST_KEY</span><span class="p">]</span>

    <span class="n">names_provided</span> <span class="o">=</span> <span class="n">IMG_NAME_KEY</span> <span class="ow">in</span> <span class="n">img_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="n">files_provided</span> <span class="o">=</span> <span class="n">IMG_F_LIST_KEY</span> <span class="ow">in</span> <span class="n">img_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="n">masks_provided</span> <span class="o">=</span> <span class="n">MASK_LIST_KEY</span> <span class="ow">in</span> <span class="n">img_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

    <span class="n">n_imgs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">img_list</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">files_provided</span><span class="p">:</span>
        <span class="n">img_f_list</span> <span class="o">=</span> <span class="n">img_dict</span><span class="p">[</span><span class="n">IMG_F_LIST_KEY</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">img_f_list</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_imgs</span>

    <span class="k">if</span> <span class="n">names_provided</span><span class="p">:</span>
        <span class="n">img_names</span> <span class="o">=</span> <span class="n">img_dict</span><span class="p">[</span><span class="n">IMG_NAME_KEY</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">files_provided</span><span class="p">:</span>
            <span class="n">img_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">valtils</span><span class="o">.</span><span class="n">get_name</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">img_f_list</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">img_names</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_imgs</span>

    <span class="k">if</span> <span class="n">masks_provided</span><span class="p">:</span>
        <span class="n">mask_list</span> <span class="o">=</span> <span class="n">img_dict</span><span class="p">[</span><span class="n">MASK_LIST_KEY</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mask_list</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_imgs</span>

    <span class="k">return</span> <span class="n">img_list</span><span class="p">,</span> <span class="n">img_f_list</span><span class="p">,</span> <span class="n">img_names</span><span class="p">,</span> <span class="n">mask_list</span>


<div class="viewcode-block" id="NonRigidZImage"><a class="viewcode-back" href="../../serial_non_rigid.html#valis.serial_non_rigid.NonRigidZImage">[docs]</a><span class="k">class</span> <span class="nc">NonRigidZImage</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Class that store info about an image, including both</span>
<span class="sd">    rigid and non-rigid registration parameters</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>

<span class="sd">    image : ndarray</span>
<span class="sd">        Original, unwarped image with shape (P, Q)</span>

<span class="sd">    name : str</span>
<span class="sd">        Name of image.</span>

<span class="sd">    stack_idx : int</span>
<span class="sd">        Position of image in the stack</span>

<span class="sd">    moving_xy : ndarray, optional</span>
<span class="sd">        (V, 2) array containing points in the moving image that correspond</span>
<span class="sd">        to those in the fixed image. If these are provided, non_rigid_reg_class</span>
<span class="sd">        should be a subclass of non_rigid_registrars.NonRigidRegistrarXY</span>

<span class="sd">    fixed_xy : ndarray, optional</span>
<span class="sd">        (V, 2) array containing points in the fixed image that correspond</span>
<span class="sd">        to those in the moving image</span>

<span class="sd">    bk_dxdy : ndarray</span>
<span class="sd">        (2, N, M) numpy array of pixel displacements in</span>
<span class="sd">        the x and y directions from the reference image.</span>
<span class="sd">        dx = bk_dxdy[0], and dy=bk_dxdy[1].</span>
<span class="sd">        Used to warp images</span>

<span class="sd">    fwd_dxdy : ndarray</span>
<span class="sd">        Inversion of bk_dxdy. dx = fwd_dxdy[0], and dy=fwd_dxdy[1].</span>
<span class="sd">        Used to warp points</span>

<span class="sd">    warped_grid : ndarray</span>
<span class="sd">        Image showing deformation applied to a regular grid.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="NonRigidZImage.__init__"><a class="viewcode-back" href="../../serial_non_rigid.html#valis.serial_non_rigid.NonRigidZImage.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg_obj</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">stack_idx</span><span class="p">,</span> <span class="n">moving_xy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fixed_xy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        image : ndarray</span>
<span class="sd">            Original, unwarped image with shape (P, Q)</span>

<span class="sd">        name : str</span>
<span class="sd">            Name of image.</span>

<span class="sd">        stack_idx : int</span>
<span class="sd">            Position of image in the stack</span>

<span class="sd">        moving_xy : ndarray, optional</span>
<span class="sd">            (V, 2) array containing points in the moving image that correspond</span>
<span class="sd">            to those in the fixed image. If these are provided, non_rigid_reg_class</span>
<span class="sd">            should be a subclass of non_rigid_registrars.NonRigidRegistrarXY</span>

<span class="sd">        fixed_xy : ndarray, optional</span>
<span class="sd">            (V, 2) array containing points in the fixed image that correspond</span>
<span class="sd">            to those in the moving image</span>

<span class="sd">        mask : ndarray, optional</span>
<span class="sd">            Mask covering area to be registered.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reg_obj</span> <span class="o">=</span> <span class="n">reg_obj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">image</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack_idx</span> <span class="o">=</span> <span class="n">stack_idx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">moving_xy</span> <span class="o">=</span> <span class="n">moving_xy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fixed_xy</span> <span class="o">=</span> <span class="n">fixed_xy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registered_img</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warped_grid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bk_dxdy</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fwd_dxdy</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">is_vips</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">pyvips</span><span class="o">.</span><span class="n">Image</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

        <span class="n">mask_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_vips</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_if_vips</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">warp_tools</span><span class="o">.</span><span class="n">numpy2vips</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">mask_shape</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">):</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">warp_tools</span><span class="o">.</span><span class="n">resize_img</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span></div>

    <span class="k">def</span> <span class="nf">get_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">pyvips</span><span class="o">.</span><span class="n">Image</span><span class="p">):</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">img</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">width</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">shape</span>

    <span class="k">def</span> <span class="nf">check_if_vips</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">pyvips</span><span class="o">.</span><span class="n">Image</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">mask_img</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">pyvips</span><span class="o">.</span><span class="n">Image</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="n">vips_mask</span> <span class="o">=</span> <span class="n">warp_tools</span><span class="o">.</span><span class="n">numpy2vips</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vips_mask</span> <span class="o">=</span> <span class="n">mask</span>
            <span class="n">masked_img</span> <span class="o">=</span> <span class="p">(</span><span class="n">vips_mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">ifthenelse</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">masked_img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">masked_img</span><span class="p">[</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="n">masked_img</span>

    <span class="k">def</span> <span class="nf">mask_dxdy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dxdy</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dxdy</span><span class="p">,</span> <span class="n">pyvips</span><span class="o">.</span><span class="n">Image</span><span class="p">):</span>
            <span class="n">masked_dxdy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_img</span><span class="p">(</span><span class="n">dxdy</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">masked_dxdy</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mask_img</span><span class="p">(</span><span class="n">dxdy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mask</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_img</span><span class="p">(</span><span class="n">dxdy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mask</span><span class="p">)]</span>

        <span class="k">return</span> <span class="n">masked_dxdy</span>

    <span class="k">def</span> <span class="nf">split_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">non_rigid_reg_class</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">init_arg_list</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="n">non_rigid_reg_class</span><span class="o">.</span><span class="fm">__init__</span><span class="p">)</span><span class="o">.</span><span class="n">args</span>
            <span class="n">reg_arg_list</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="n">non_rigid_reg_class</span><span class="o">.</span><span class="n">register</span><span class="p">)</span><span class="o">.</span><span class="n">args</span>

            <span class="n">init_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">init_arg_list</span><span class="p">}</span>
            <span class="n">reg_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">reg_arg_list</span><span class="p">}</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">init_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">reg_kwargs</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">return</span> <span class="n">init_kwargs</span><span class="p">,</span> <span class="n">reg_kwargs</span>

    <span class="k">def</span> <span class="nf">calc_deformation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">registered_fixed_image</span><span class="p">,</span> <span class="n">non_rigid_reg_class</span><span class="p">,</span>
                         <span class="n">bk_dxdy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finds the non-rigid deformation fields that align this (&quot;moving&quot;) image</span>
<span class="sd">        to the &quot;fixed&quot; image</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        registered_fixed_image : ndarray</span>
<span class="sd">            Adjacent, aligned image in the stack that this image is being</span>
<span class="sd">            aligned to. Has shape (P, Q)</span>

<span class="sd">        non_rigid_reg_class : NonRigidRegistrar</span>
<span class="sd">            Uninstantiated NonRigidRegistrar class that will be used to</span>
<span class="sd">            calculate the deformation fields between images</span>

<span class="sd">        bk_dxdy : ndarray, optional</span>
<span class="sd">            (2, P, Q) numpy array of pixel displacements in</span>
<span class="sd">            the x and y directions. dx = dxdy[0], and dy=dxdy[1].</span>
<span class="sd">            Used to warp the registered_img before finding deformation fields.</span>

<span class="sd">        params : dictionary, optional</span>
<span class="sd">            Keyword: value dictionary of parameters to be used in reigstration.</span>
<span class="sd">            Passed to the non_rigid_reg_class&#39; init() method.</span>

<span class="sd">            In the case where simple ITK will be used, params should be</span>
<span class="sd">            a SimpleITK.ParameterMap. Note that numeric values needd to be</span>
<span class="sd">            converted to strings.</span>

<span class="sd">        mask : ndarray, optional</span>
<span class="sd">            2D array with shape (P,Q) where non-zero pixel values are foreground,</span>
<span class="sd">            and 0 is background, which is ignnored during registration. If None,</span>
<span class="sd">            then all non-zero pixels in images will be used to create the mask.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_obj</span><span class="o">.</span><span class="n">from_rigid_reg</span><span class="p">:</span>
            <span class="n">rigid_img_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_obj</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">img_obj_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
            <span class="n">M</span> <span class="o">=</span> <span class="n">rigid_img_obj</span><span class="o">.</span><span class="n">M</span>
            <span class="n">unwarped_shape</span> <span class="o">=</span> <span class="n">rigid_img_obj</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">og_reg_shape_rc</span> <span class="o">=</span> <span class="n">rigid_img_obj</span><span class="o">.</span><span class="n">registered_shape_rc</span>

        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="n">pyvips</span><span class="o">.</span><span class="n">Image</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">pyvips</span><span class="o">.</span><span class="n">Image</span><span class="p">):</span>
                        <span class="n">vips_mask</span> <span class="o">=</span> <span class="n">warp_tools</span><span class="o">.</span><span class="n">numpy2vips</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">vips_mask</span> <span class="o">=</span> <span class="n">mask</span>

                    <span class="n">combo_mask</span> <span class="o">=</span> <span class="n">vips_mask</span><span class="o">.</span><span class="n">bandjoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
                    <span class="n">reg_mask</span> <span class="o">=</span> <span class="n">combo_mask</span><span class="o">.</span><span class="n">bandand</span><span class="p">()</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">reg_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
                    <span class="n">reg_mask</span><span class="p">[(</span><span class="n">mask</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">255</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">reg_mask</span> <span class="o">=</span> <span class="n">mask</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">reg_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span>

        <span class="k">if</span> <span class="n">bk_dxdy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bk_dxdy</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">bk_dxdy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bk_dxdy</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">for_reg_dxdy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_dxdy</span><span class="p">(</span><span class="n">bk_dxdy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">for_reg_dxdy</span> <span class="o">=</span> <span class="n">bk_dxdy</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_obj</span><span class="o">.</span><span class="n">from_rigid_reg</span><span class="p">:</span>
                <span class="n">for_reg_dxdy</span> <span class="o">=</span> <span class="n">warp_tools</span><span class="o">.</span><span class="n">remove_invasive_displacements</span><span class="p">(</span><span class="n">for_reg_dxdy</span><span class="p">,</span>
                                                                        <span class="n">M</span><span class="o">=</span><span class="n">M</span><span class="p">,</span>
                                                                        <span class="n">src_shape_rc</span><span class="o">=</span><span class="n">unwarped_shape</span><span class="p">,</span>
                                                                        <span class="n">out_shape_rc</span><span class="o">=</span><span class="n">og_reg_shape_rc</span>
                                                                        <span class="p">)</span>

            <span class="n">moving_img</span> <span class="o">=</span> <span class="n">warp_tools</span><span class="o">.</span><span class="n">warp_img</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">bk_dxdy</span><span class="o">=</span><span class="n">for_reg_dxdy</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">reg_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Update mask too</span>
                <span class="n">reg_mask</span> <span class="o">=</span> <span class="n">warp_tools</span><span class="o">.</span><span class="n">warp_img</span><span class="p">(</span><span class="n">reg_mask</span><span class="p">,</span> <span class="n">bk_dxdy</span><span class="o">=</span><span class="n">for_reg_dxdy</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">moving_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">for_reg_dxdy</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_vips</span><span class="p">:</span>
                <span class="n">bk_dxdy</span> <span class="o">=</span> <span class="n">pyvips</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">black</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bands</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bk_dxdy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])])</span>

        <span class="n">init_kwargs</span><span class="p">,</span> <span class="n">reg_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_params</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">non_rigid_reg_class</span><span class="p">)</span>

        <span class="n">non_rigid_reg</span> <span class="o">=</span> <span class="n">non_rigid_reg_class</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">init_kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">moving_xy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixed_xy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
           <span class="nb">issubclass</span><span class="p">(</span><span class="n">non_rigid_reg_class</span><span class="p">,</span> <span class="n">non_rigid_registrars</span><span class="o">.</span><span class="n">NonRigidRegistrarXY</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">for_reg_dxdy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Update positions #</span>
                <span class="n">fwd_dxdy</span> <span class="o">=</span> <span class="n">warp_tools</span><span class="o">.</span><span class="n">get_inverse_field</span><span class="p">(</span><span class="n">for_reg_dxdy</span><span class="p">)</span>
                <span class="n">fixed_xy</span> <span class="o">=</span> <span class="n">warp_tools</span><span class="o">.</span><span class="n">warp_xy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fixed_xy</span><span class="p">,</span> <span class="n">M</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fwd_dxdy</span><span class="o">=</span><span class="n">fwd_dxdy</span><span class="p">)</span>
                <span class="n">moving_xy</span> <span class="o">=</span> <span class="n">warp_tools</span><span class="o">.</span><span class="n">warp_xy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">moving_xy</span><span class="p">,</span> <span class="n">M</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fwd_dxdy</span><span class="o">=</span><span class="n">fwd_dxdy</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fixed_xy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixed_xy</span>
                <span class="n">moving_xy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">moving_xy</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fixed_xy</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">moving_xy</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">xy_args</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;moving_xy&quot;</span><span class="p">:</span> <span class="n">moving_xy</span><span class="p">,</span> <span class="s2">&quot;fixed_xy&quot;</span><span class="p">:</span> <span class="n">fixed_xy</span><span class="p">}</span>
        <span class="n">reg_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">xy_args</span><span class="p">)</span>

        <span class="n">warped_moving</span><span class="p">,</span> <span class="n">moving_grid_img</span><span class="p">,</span> <span class="n">moving_bk_dxdy</span> <span class="o">=</span> \
            <span class="n">non_rigid_reg</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">moving_img</span><span class="o">=</span><span class="n">moving_img</span><span class="p">,</span>
                                   <span class="n">fixed_img</span><span class="o">=</span><span class="n">registered_fixed_image</span><span class="p">,</span>
                                   <span class="n">mask</span><span class="o">=</span><span class="n">reg_mask</span><span class="p">,</span>
                                   <span class="o">**</span><span class="n">reg_kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_obj</span><span class="o">.</span><span class="n">from_rigid_reg</span><span class="p">:</span>
            <span class="n">moving_bk_dxdy</span> <span class="o">=</span> <span class="n">warp_tools</span><span class="o">.</span><span class="n">remove_invasive_displacements</span><span class="p">(</span><span class="n">moving_bk_dxdy</span><span class="p">,</span>
                                                                      <span class="n">M</span><span class="o">=</span><span class="n">M</span><span class="p">,</span>
                                                                      <span class="n">src_shape_rc</span><span class="o">=</span><span class="n">unwarped_shape</span><span class="p">,</span>
                                                                      <span class="n">out_shape_rc</span><span class="o">=</span><span class="n">og_reg_shape_rc</span>
                                                                      <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_if_vips</span><span class="p">(</span><span class="n">moving_bk_dxdy</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Only add new transformations</span>
                <span class="n">moving_bk_dxdy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_dxdy</span><span class="p">(</span><span class="n">moving_bk_dxdy</span><span class="p">,</span> <span class="n">reg_mask</span><span class="p">)</span>
            <span class="n">bk_dxdy_from_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">bk_dxdy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">moving_bk_dxdy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                         <span class="n">bk_dxdy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">moving_bk_dxdy</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">moving_bk_dxdy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_dxdy</span><span class="p">(</span><span class="n">moving_bk_dxdy</span><span class="p">,</span> <span class="n">reg_mask</span><span class="p">)</span>
                <span class="n">bk_dxdy_from_ref</span> <span class="o">=</span> <span class="n">bk_dxdy</span> <span class="o">+</span> <span class="n">moving_bk_dxdy</span>

        <span class="n">img_bk_dxdy</span> <span class="o">=</span> <span class="n">bk_dxdy_from_ref</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">img_bk_dxdy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_dxdy</span><span class="p">(</span><span class="n">img_bk_dxdy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_obj</span><span class="o">.</span><span class="n">from_rigid_reg</span><span class="p">:</span>
            <span class="n">img_bk_dxdy</span> <span class="o">=</span> <span class="n">warp_tools</span><span class="o">.</span><span class="n">remove_invasive_displacements</span><span class="p">(</span><span class="n">img_bk_dxdy</span><span class="p">,</span>
                                                                   <span class="n">M</span><span class="o">=</span><span class="n">M</span><span class="p">,</span>
                                                                   <span class="n">src_shape_rc</span><span class="o">=</span><span class="n">unwarped_shape</span><span class="p">,</span>
                                                                   <span class="n">out_shape_rc</span><span class="o">=</span><span class="n">og_reg_shape_rc</span>
                                                                   <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bk_dxdy</span> <span class="o">=</span> <span class="n">img_bk_dxdy</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">non_rigid_reg</span><span class="p">,</span> <span class="s2">&quot;fwd_dxdy&quot;</span><span class="p">):</span>
            <span class="c1"># Already calculated</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fwd_dxdy</span> <span class="o">=</span> <span class="n">non_rigid_reg</span><span class="o">.</span><span class="n">fwd_dxdy</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fwd_dxdy</span> <span class="o">=</span> <span class="n">warp_tools</span><span class="o">.</span><span class="n">get_inverse_field</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bk_dxdy</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_vips</span><span class="p">:</span>
            <span class="c1"># If dxdy is a pyvips.Image, it&#39;s likely the displacement is too large to draw</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warped_grid</span> <span class="o">=</span> <span class="n">viz</span><span class="o">.</span><span class="n">color_displacement_grid</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">bk_dxdy</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">registered_img</span> <span class="o">=</span> <span class="n">warp_tools</span><span class="o">.</span><span class="n">warp_img</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span>
                                                  <span class="n">bk_dxdy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bk_dxdy</span><span class="p">,</span>
                                                  <span class="n">out_shape_rc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">bk_dxdy_from_ref</span></div>


<div class="viewcode-block" id="SerialNonRigidRegistrar"><a class="viewcode-back" href="../../serial_non_rigid.html#valis.serial_non_rigid.SerialNonRigidRegistrar">[docs]</a><span class="k">class</span> <span class="nc">SerialNonRigidRegistrar</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class that performs serial non-rigid registration, based on results SerialRigidRegistrar</span>

<span class="sd">    A SerialNonRigidRegistrar finds the deformation fields that will non-rigidly align</span>
<span class="sd">    a series of images, using the rigid registration parameters found by a</span>
<span class="sd">    SerialRigidRegistrar object. There are two types of non-rigid registration</span>
<span class="sd">    methods:</span>

<span class="sd">    #. Images are aligned towards a reference image, which may or may not</span>
<span class="sd">    be at the center of the stack. In this case, the image directly &quot;above&quot; the</span>
<span class="sd">    reference image is aligned to the reference image, after which the image 2 steps</span>
<span class="sd">    above the reference image is aligned to the 1st (now aligned) image above</span>
<span class="sd">    the reference image, and so on. The process is similar when aligning images</span>
<span class="sd">    &quot;below&quot; the reference image.</span>

<span class="sd">    #. All images are aligned simultaneously, and so a reference image is not</span>
<span class="sd">    # required. An example is the SimpleElastix groupwise registration.</span>

<span class="sd">    Similar to SerialRigidRegistrar, SerialNonRigidRegistrar creates a list</span>
<span class="sd">    and dictionary of NonRigidZImage objects each of which contains information</span>
<span class="sd">    related to the non-rigid registration, including the original rigid</span>
<span class="sd">    transformation matrices, and the calculated deformation fields.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    name : str, optional</span>
<span class="sd">        Optional name of this SerialNonRigidRegistrar</span>

<span class="sd">    from_rigid_reg : bool</span>
<span class="sd">        Whether or not the images are from a SerialRigidRegistrar</span>

<span class="sd">    ref_image_name : str</span>
<span class="sd">        Name of mage that is being treated as the &quot;center&quot; of the stack.</span>
<span class="sd">        For example, this may be associated with an H+E image that is</span>
<span class="sd">        the 2nd image in a stack of 7 images.</span>

<span class="sd">    size : int</span>
<span class="sd">        Number of images to align</span>

<span class="sd">    shape : tuple of int</span>
<span class="sd">        Shape of each image to register. Must be the same for all images</span>

<span class="sd">    non_rigid_obj_dict : dict</span>
<span class="sd">        Dictionary, where each key is the name of a NonRigidZImage, and</span>
<span class="sd">        the value is the assocatiated NonRigidZImage</span>

<span class="sd">    non_rigid_reg_params: dictionary</span>
<span class="sd">        Dictionary containing parameters {name: value} to be used to initialize</span>
<span class="sd">        the NonRigidRegistrar.</span>
<span class="sd">        In the case where simple ITK is used by the, params should be</span>
<span class="sd">        a SimpleITK.ParameterMap. Note that numeric values nedd to be</span>
<span class="sd">        converted to strings.</span>

<span class="sd">    mask :  ndarray</span>
<span class="sd">        Mask used in non-rigid alignments, with shape (P, Q).</span>

<span class="sd">    mask_bbox_xywh : ndarray</span>
<span class="sd">        Bounding box of `mask` (top left x, top left y, width, height)</span>

<span class="sd">    summary : Dataframe</span>
<span class="sd">        Pandas dataframe containing the median distance between matched</span>
<span class="sd">        features before and after registration.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="SerialNonRigidRegistrar.__init__"><a class="viewcode-back" href="../../serial_non_rigid.html#valis.serial_non_rigid.SerialNonRigidRegistrar.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">reference_img_f</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">moving_to_fixed_xy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">align_to_reference</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">compose_transforms</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        src : SerialRigidRegistrar, str, dict</span>

<span class="sd">            A SerialRigidRegistrar object that was used to optimally</span>
<span class="sd">            align a series of images.</span>

<span class="sd">            If a string, it should indicating where the images</span>
<span class="sd">            to be aligned are located. If src is a string, the images should be</span>
<span class="sd">            named such that they are read in the correct order, i.e. each</span>
<span class="sd">            starting with a number.</span>

<span class="sd">            If a dictionary, it should contain the following key, value pairs:</span>

<span class="sd">            &quot;img_list&quot; : list of images to register</span>
<span class="sd">            &quot;img_f_list&quot; : list of filenames of each image</span>
<span class="sd">            &quot;name_list&quot; : list of image names. If not provided, will come from file names</span>
<span class="sd">            &quot;mask_list&quot; list of masks for each image</span>


<span class="sd">        reference_img_f : str, optional</span>
<span class="sd">            Filename of image that will be treated as the center of the stack.</span>
<span class="sd">            If None, the index of the middle image will be returned.</span>

<span class="sd">        moving_to_fixed_xy :  dict of list, or bool</span>
<span class="sd">            If `moving_to_fixed_xy` is a dict of list, then</span>
<span class="sd">            Key = image name, value = list of matched keypoints between</span>
<span class="sd">            each moving image and the fixed image.</span>
<span class="sd">            Each element in the list contains 2 arrays:</span>

<span class="sd">            #. Rigid registered xy in moving/current/from image</span>
<span class="sd">            #. Rigid registered xy in fixed/next/to image</span>

<span class="sd">            To deterime which pairs of images will be aligned, use</span>
<span class="sd">            `get_alignment_indices`. Can use `get_imgs_from_dir`</span>
<span class="sd">            to see the order inwhich the images will be read, which will correspond</span>
<span class="sd">            to the indices retuned by `get_alignment_indices`.</span>

<span class="sd">            If `src` is a SerialRigidRegistrar and `moving_to_fixed_xy` is</span>
<span class="sd">            True, then the matching features in the SerialRigidRegistrar will</span>
<span class="sd">            be used. If False, then matching features will not be used.</span>

<span class="sd">        mask :  ndarray, bool, optional</span>
<span class="sd">            Mask used for all non-rigid alignments.</span>

<span class="sd">            If an ndarray, it must have the same size as the other images.</span>

<span class="sd">            If True, then the `overlap_mask` in the SerialRigidRegistrar</span>
<span class="sd">            will be used.</span>

<span class="sd">            If False or None, no mask will be used.</span>

<span class="sd">        name : optional</span>
<span class="sd">            Optional name for this SerialNonRigidRegistrar</span>

<span class="sd">        align_to_reference : bool, optional</span>
<span class="sd">            Whether or not images should be aligned to a reference image</span>
<span class="sd">            specified by `reference_img_f`.</span>

<span class="sd">        img_params : dict, optional</span>
<span class="sd">            Dictionary of parameters to be used for each particular image.</span>
<span class="sd">            Useful if images to be registered haven&#39;t been processed.</span>
<span class="sd">            Will be passed to `non_rigid_reg_class` init and register functions.</span>
<span class="sd">            key = file name, value= dictionary of keyword arguments and values</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">src</span> <span class="o">=</span> <span class="n">src</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">serial_rigid</span><span class="o">.</span><span class="n">SerialRigidRegistrar</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">from_rigid_reg</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">from_rigid_reg</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">from_rigid_reg</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">valtils</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;src must be either a SerialRigidRegistrar, string, or dictionary&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">non_rigid_obj_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">non_rigid_obj_list</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">non_rigid_reg_params</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">summary</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reference_img_f</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_img_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_img_idx</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compose_transforms</span> <span class="o">=</span> <span class="n">compose_transforms</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">align_to_reference</span> <span class="o">=</span> <span class="n">align_to_reference</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_non_rigid_obj_list</span><span class="p">(</span><span class="n">reference_img_f</span><span class="p">,</span> <span class="n">moving_to_fixed_xy</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">align_to_reference</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">reference_img_f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">og_ref_name</span> <span class="o">=</span> <span class="n">valtils</span><span class="o">.</span><span class="n">get_name</span><span class="p">(</span><span class="n">reference_img_f</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The reference was specified as </span><span class="si">{</span><span class="n">og_ref_name</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">,</span>
                   <span class="sa">f</span><span class="s2">&quot;but `align_to_reference` is `False`, and so images will be aligned serially. &quot;</span><span class="p">,</span>
                   <span class="sa">f</span><span class="s2">&quot;If you would like all images to be directly aligned to </span><span class="si">{</span><span class="n">og_ref_name</span><span class="si">}</span><span class="s2">, &quot;</span>
                   <span class="sa">f</span><span class="s2">&quot;then set `align_to_reference` to `True`&quot;</span><span class="p">)</span>
            <span class="n">valtils</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">get_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">pyvips</span><span class="o">.</span><span class="n">Image</span><span class="p">):</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">img</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">width</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">shape</span>

    <span class="k">def</span> <span class="nf">create_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">temp_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">nr_img_obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_rigid_obj_list</span><span class="p">:</span>
            <span class="n">temp_mask</span><span class="p">[</span><span class="n">nr_img_obj</span><span class="o">.</span><span class="n">image</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="n">warp_tools</span><span class="o">.</span><span class="n">bbox2mask</span><span class="p">(</span><span class="o">*</span><span class="n">warp_tools</span><span class="o">.</span><span class="n">xy2bbox</span><span class="p">(</span>
                                    <span class="n">warp_tools</span><span class="o">.</span><span class="n">mask2xy</span><span class="p">(</span><span class="n">temp_mask</span><span class="p">)),</span>
                                    <span class="n">temp_mask</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mask</span>

    <span class="k">def</span> <span class="nf">set_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set mask and get its bounding box</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_rigid_reg</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">overlap_mask</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">*</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_mask</span><span class="p">()</span>

        <span class="n">mask_bbox_xywh</span> <span class="o">=</span> <span class="n">warp_tools</span><span class="o">.</span><span class="n">xy2bbox</span><span class="p">(</span><span class="n">warp_tools</span><span class="o">.</span><span class="n">mask2xy</span><span class="p">(</span><span class="n">mask</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask_bbox_xywh</span> <span class="o">=</span> <span class="n">mask_bbox_xywh</span>

    <span class="k">def</span> <span class="nf">generate_non_rigid_obj_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reference_img_f</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">moving_to_fixed_xy</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create non_rigid_obj_list</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_rigid_reg</span><span class="p">:</span>
            <span class="n">img_list</span><span class="p">,</span> <span class="n">img_f_list</span><span class="p">,</span> <span class="n">img_names</span><span class="p">,</span> <span class="n">mask_list</span> <span class="o">=</span> \
                <span class="n">get_imgs_rigid_reg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">img_list</span><span class="p">,</span> <span class="n">img_f_list</span><span class="p">,</span> <span class="n">img_names</span><span class="p">,</span> <span class="n">mask_list</span> <span class="o">=</span> \
                    <span class="n">get_imgs_from_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">)</span>
                <span class="c1"># overwrite `src` because all info now in NonRigidZImages</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">src</span> <span class="o">=</span> <span class="s2">&quot;dictionary&quot;</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">img_list</span><span class="p">,</span> <span class="n">img_f_list</span><span class="p">,</span> <span class="n">img_names</span><span class="p">,</span> <span class="n">mask_list</span> <span class="o">=</span> \
                    <span class="n">get_imgs_from_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">img_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(</span><span class="n">img_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">reference_img_f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">reference_name</span> <span class="o">=</span> <span class="n">valtils</span><span class="o">.</span><span class="n">get_name</span><span class="p">(</span><span class="n">reference_img_f</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">reference_name</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">ref_img_idx</span> <span class="o">=</span> <span class="n">warp_tools</span><span class="o">.</span><span class="n">get_ref_img_idx</span><span class="p">(</span><span class="n">img_f_list</span><span class="p">,</span> <span class="n">reference_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">reference_img_f</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">reference_img_f</span> <span class="o">=</span> <span class="n">img_f_list</span><span class="p">[</span><span class="n">ref_img_idx</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reference_img_f</span> <span class="o">=</span> <span class="n">reference_img_f</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_img_idx</span> <span class="o">=</span> <span class="n">ref_img_idx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_img_name</span> <span class="o">=</span> <span class="n">reference_name</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_rigid_reg</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">moving_to_fixed_xy</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">moving_to_fixed_xy</span><span class="p">:</span>
                <span class="n">moving_to_fixed_xy</span> <span class="o">=</span> \
                    <span class="n">get_matching_xy_from_rigid_registrar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">,</span> <span class="n">reference_name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">moving_to_fixed_xy</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">non_rigid_obj_list</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">img</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">img_list</span><span class="p">):</span>
            <span class="n">img_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">img_shape</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> \
                <span class="n">valtils</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="s2">&quot;Images must all have the shape&quot;</span><span class="p">)</span>

            <span class="n">img_name</span> <span class="o">=</span> <span class="n">img_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="n">pyvips</span><span class="o">.</span><span class="n">Image</span><span class="p">):</span>
                    <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">bandjoin</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span><span class="o">.</span><span class="n">bandand</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>

            <span class="n">moving_xy</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">fixed_xy</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">moving_to_fixed_xy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">img_name</span> <span class="o">!=</span> <span class="n">reference_img_f</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">moving_to_fixed_xy</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">xy_coords</span> <span class="o">=</span> <span class="n">moving_to_fixed_xy</span><span class="p">[</span><span class="n">img_name</span><span class="p">]</span>
                    <span class="n">moving_xy</span> <span class="o">=</span> <span class="n">xy_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">fixed_xy</span> <span class="o">=</span> <span class="n">xy_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;moving_to_fixed_xy is not a dictionary. Will be ignored&quot;</span>
                    <span class="n">valtils</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="n">nr_obj</span> <span class="o">=</span> <span class="n">NonRigidZImage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">img_name</span><span class="p">,</span> <span class="n">stack_idx</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
                                    <span class="n">moving_xy</span><span class="o">=</span><span class="n">moving_xy</span><span class="p">,</span>
                                    <span class="n">fixed_xy</span><span class="o">=</span><span class="n">fixed_xy</span><span class="p">,</span>
                                    <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">ref_img_idx</span><span class="p">:</span>
                <span class="c1"># Set reference image attributes #</span>
                <span class="n">zero_displacement</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">nr_obj</span><span class="o">.</span><span class="n">is_vips</span><span class="p">:</span>
                    <span class="n">nr_obj</span><span class="o">.</span><span class="n">bk_dxdy</span> <span class="o">=</span> <span class="p">[</span><span class="n">zero_displacement</span><span class="p">,</span> <span class="n">zero_displacement</span><span class="p">]</span>
                    <span class="n">nr_obj</span><span class="o">.</span><span class="n">fwd_dxdy</span> <span class="o">=</span> <span class="p">[</span><span class="n">zero_displacement</span><span class="p">,</span> <span class="n">zero_displacement</span><span class="p">]</span>
                    <span class="n">nr_obj</span><span class="o">.</span><span class="n">warped_grid</span> <span class="o">=</span> <span class="n">viz</span><span class="o">.</span><span class="n">color_displacement_grid</span><span class="p">(</span><span class="o">*</span><span class="n">nr_obj</span><span class="o">.</span><span class="n">bk_dxdy</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">nr_obj</span><span class="o">.</span><span class="n">bk_dxdy</span> <span class="o">=</span> <span class="n">pyvips</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">black</span><span class="p">(</span><span class="n">nr_obj</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nr_obj</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bands</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">nr_obj</span><span class="o">.</span><span class="n">fwd_dxdy</span> <span class="o">=</span> <span class="n">pyvips</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">black</span><span class="p">(</span><span class="n">nr_obj</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nr_obj</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bands</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

                <span class="n">nr_obj</span><span class="o">.</span><span class="n">registered_img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">non_rigid_obj_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">nr_obj</span>

    <span class="k">def</span> <span class="nf">update_img_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">non_rigid_reg_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">img_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">img_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">indv_img_params</span> <span class="o">=</span> <span class="n">img_params</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">indv_img_params</span> <span class="o">=</span> <span class="n">img_params</span>

        <span class="k">if</span> <span class="n">non_rigid_reg_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">indv_img_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="n">updated_params</span> <span class="o">=</span> <span class="n">indv_img_params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">updated_params</span><span class="p">[</span><span class="n">non_rigid_registrars</span><span class="o">.</span><span class="n">NR_PARAMS_KEY</span><span class="p">]</span> <span class="o">=</span> <span class="n">non_rigid_reg_params</span>

        <span class="k">elif</span> <span class="n">non_rigid_reg_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">indv_img_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">updated_params</span> <span class="o">=</span> <span class="n">non_rigid_reg_params</span>

        <span class="k">elif</span> <span class="n">non_rigid_reg_params</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">indv_img_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">updated_params</span> <span class="o">=</span> <span class="n">indv_img_params</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">updated_params</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">updated_params</span>


    <span class="k">def</span> <span class="nf">register_serial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">non_rigid_reg_class</span><span class="p">,</span> <span class="n">non_rigid_reg_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">img_params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Non-rigidly align images in serial</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        non_rigid_reg_class : NonRigidRegistrar</span>
<span class="sd">            Uninstantiated NonRigidRegistrar class that will be used to</span>
<span class="sd">            calculate the deformation fields between images</span>

<span class="sd">        non_rigid_reg_params: dictionary, optional</span>
<span class="sd">            Dictionary containing parameters {name: value} to be used to initialize</span>
<span class="sd">            the NonRigidRegistrar.</span>
<span class="sd">            In the case where simple ITK is used by the, params should be</span>
<span class="sd">            a SimpleITK.ParameterMap. Note that numeric values nedd to be</span>
<span class="sd">            converted to strings.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">current_dxdy</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">non_rigid_reg_params</span> <span class="o">=</span> <span class="n">non_rigid_reg_params</span>
        <span class="n">iter_order</span> <span class="o">=</span> <span class="n">warp_tools</span><span class="o">.</span><span class="n">get_alignment_indices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_img_idx</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">moving_idx</span><span class="p">,</span> <span class="n">fixed_idx</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">iter_order</span><span class="p">):</span>
            <span class="n">moving_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_rigid_obj_list</span><span class="p">[</span><span class="n">moving_idx</span><span class="p">]</span>
            <span class="n">fixed_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_rigid_obj_list</span><span class="p">[</span><span class="n">fixed_idx</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compose_transforms</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fixed_obj</span><span class="o">.</span><span class="n">stack_idx</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_img_idx</span><span class="p">:</span>
                    <span class="n">current_dxdy</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">current_dxdy</span> <span class="o">=</span> <span class="n">updated_dxdy</span>

            <span class="n">nr_reg_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_img_params</span><span class="p">(</span><span class="n">non_rigid_reg_params</span><span class="p">,</span> <span class="n">img_params</span><span class="p">,</span> <span class="n">moving_obj</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="n">updated_dxdy</span> <span class="o">=</span> <span class="n">moving_obj</span><span class="o">.</span><span class="n">calc_deformation</span><span class="p">(</span><span class="n">registered_fixed_image</span><span class="o">=</span><span class="n">fixed_obj</span><span class="o">.</span><span class="n">registered_img</span><span class="p">,</span>
                                        <span class="n">non_rigid_reg_class</span><span class="o">=</span><span class="n">non_rigid_reg_class</span><span class="p">,</span>
                                        <span class="n">bk_dxdy</span><span class="o">=</span><span class="n">current_dxdy</span><span class="p">,</span>
                                        <span class="n">params</span><span class="o">=</span><span class="n">nr_reg_params</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">register_to_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">non_rigid_reg_class</span><span class="p">,</span> <span class="n">non_rigid_reg_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">img_params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Non-rigidly align images to a reference image</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        non_rigid_reg_class : NonRigidRegistrar</span>
<span class="sd">            Uninstantiated NonRigidRegistrar class that will be used to</span>
<span class="sd">            calculate the deformation fields between images</span>

<span class="sd">        non_rigid_reg_params: dictionary, optional</span>
<span class="sd">            Dictionary containing parameters {name: value} to be used to initialize</span>
<span class="sd">            the NonRigidRegistrar.</span>
<span class="sd">            In the case where simple ITK is used by the, params should be</span>
<span class="sd">            a SimpleITK.ParameterMap. Note that numeric values nedd to be</span>
<span class="sd">            converted to strings.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">non_rigid_reg_params</span> <span class="o">=</span> <span class="n">non_rigid_reg_params</span>
        <span class="n">ref_nr_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_rigid_obj_list</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_img_idx</span><span class="p">]</span>
        <span class="n">ref_img</span> <span class="o">=</span> <span class="n">ref_nr_obj</span><span class="o">.</span><span class="n">image</span>
        <span class="k">for</span> <span class="n">moving_idx</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">)):</span>
            <span class="n">moving_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_rigid_obj_list</span><span class="p">[</span><span class="n">moving_idx</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">moving_obj</span><span class="o">.</span><span class="n">stack_idx</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_img_idx</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">overlap_mask</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">nr_reg_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_img_params</span><span class="p">(</span><span class="n">non_rigid_reg_params</span><span class="p">,</span> <span class="n">img_params</span><span class="p">,</span> <span class="n">moving_obj</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="n">moving_obj</span><span class="o">.</span><span class="n">calc_deformation</span><span class="p">(</span><span class="n">ref_img</span><span class="p">,</span>
                                        <span class="n">non_rigid_reg_class</span><span class="p">,</span>
                                        <span class="n">params</span><span class="o">=</span><span class="n">nr_reg_params</span><span class="p">,</span>
                                        <span class="n">mask</span><span class="o">=</span><span class="n">overlap_mask</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">register_groupwise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">non_rigid_reg_class</span><span class="p">,</span> <span class="n">non_rigid_reg_params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Non-rigidly align images as a group</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        non_rigid_reg_class : NonRigidRegistrarGroupwise</span>
<span class="sd">            Uninstantiated NonRigidRegistrar class that will be used to</span>
<span class="sd">            calculate the deformation fields between images</span>

<span class="sd">        non_rigid_reg_params: dictionary, optional</span>
<span class="sd">            Dictionary containing parameters {name: value} to be used to initialize</span>
<span class="sd">            the NonRigidRegistrar.</span>
<span class="sd">            In the case where simple ITK is used by the, params should be</span>
<span class="sd">            a SimpleITK.ParameterMap. Note that numeric values nedd to be</span>
<span class="sd">            converted to strings.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">img_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">nr_img_obj</span><span class="o">.</span><span class="n">image</span> <span class="k">for</span> <span class="n">nr_img_obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_rigid_obj_list</span><span class="p">]</span>
        <span class="n">non_rigid_reg</span> <span class="o">=</span> <span class="n">non_rigid_reg_class</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">non_rigid_reg_params</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">======== Registering images (non-rigid)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">warped_imgs</span><span class="p">,</span> <span class="n">warped_grids</span><span class="p">,</span> <span class="n">backward_deformations</span> <span class="o">=</span> <span class="n">non_rigid_reg</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">img_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">nr_img_obj</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">non_rigid_obj_list</span><span class="p">):</span>
            <span class="n">nr_img_obj</span><span class="o">.</span><span class="n">registered_img</span> <span class="o">=</span> <span class="n">warped_imgs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">nr_img_obj</span><span class="o">.</span><span class="n">bk_dxdy</span> <span class="o">=</span> <span class="n">backward_deformations</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">nr_img_obj</span><span class="o">.</span><span class="n">warped_grid</span> <span class="o">=</span> <span class="n">viz</span><span class="o">.</span><span class="n">color_displacement_grid</span><span class="p">(</span><span class="o">*</span><span class="n">nr_img_obj</span><span class="o">.</span><span class="n">bk_dxdy</span><span class="p">)</span>
            <span class="n">nr_img_obj</span><span class="o">.</span><span class="n">fwd_dxdy</span> <span class="o">=</span> <span class="n">warp_tools</span><span class="o">.</span><span class="n">get_inverse_field</span><span class="p">(</span><span class="n">nr_img_obj</span><span class="o">.</span><span class="n">bk_dxdy</span><span class="p">)</span>

<div class="viewcode-block" id="SerialNonRigidRegistrar.register"><a class="viewcode-back" href="../../serial_non_rigid.html#valis.serial_non_rigid.SerialNonRigidRegistrar.register">[docs]</a>    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">non_rigid_reg_class</span><span class="p">,</span> <span class="n">non_rigid_reg_params</span><span class="p">,</span> <span class="n">img_params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Non-rigidly align images, either as a group or serially</span>

<span class="sd">        Images will be registered serially if `non_rigid_reg_class` is a</span>
<span class="sd">        subclass of NonRigidRegistrarGroupwise, then groupwise registration</span>
<span class="sd">        will be conductedd. If `non_rigid_reg_class` is a subclass of</span>
<span class="sd">        NonRigidRegistrar then images will be aligned serially.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        non_rigid_reg_class : NonRigidRegistrar, NonRigidRegistrarGroupwise</span>
<span class="sd">            Uninstantiated NonRigidRegistrar or NonRigidRegistrarGroupwise class</span>
<span class="sd">            that will be used to calculate the deformation fields between images</span>

<span class="sd">        non_rigid_reg_params: dictionary, optional</span>
<span class="sd">            Dictionary containing parameters {name: value} to be used to initialize</span>
<span class="sd">            the NonRigidRegistrar.</span>
<span class="sd">            In the case where simple ITK is used by the, params should be</span>
<span class="sd">            a SimpleITK.ParameterMap. Note that numeric values nedd to be</span>
<span class="sd">            converted to strings.</span>
<span class="sd">        img_params : dict, optional</span>
<span class="sd">            Dictionary of parameters to be used for each particular image.</span>
<span class="sd">            Useful if images to be registered haven&#39;t been processed.</span>
<span class="sd">            Will be passed to `non_rigid_reg_class` init and register functions.</span>
<span class="sd">            key = file name, value= dictionary of keyword arguments and values</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">img_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">named_img_params</span> <span class="o">=</span> <span class="p">{</span><span class="n">valtils</span><span class="o">.</span><span class="n">get_name</span><span class="p">(</span><span class="n">k</span><span class="p">):</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">img_params</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">named_img_params</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">non_rigid_reg_class</span><span class="p">,</span> <span class="n">non_rigid_registrars</span><span class="o">.</span><span class="n">NonRigidRegistrarGroupwise</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register_groupwise</span><span class="p">(</span><span class="n">non_rigid_reg_class</span><span class="p">,</span> <span class="n">non_rigid_reg_params</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">align_to_reference</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register_to_ref</span><span class="p">(</span><span class="n">non_rigid_reg_class</span><span class="p">,</span> <span class="n">non_rigid_reg_params</span><span class="p">,</span> <span class="n">img_params</span><span class="o">=</span><span class="n">named_img_params</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register_serial</span><span class="p">(</span><span class="n">non_rigid_reg_class</span><span class="p">,</span> <span class="n">non_rigid_reg_params</span><span class="p">,</span> <span class="n">img_params</span><span class="o">=</span><span class="n">named_img_params</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">non_rigid_obj_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">img_obj</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">img_obj</span> <span class="k">for</span> <span class="n">img_obj</span>
                                   <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_rigid_obj_list</span><span class="p">}</span></div>

<div class="viewcode-block" id="SerialNonRigidRegistrar.summarize"><a class="viewcode-back" href="../../serial_non_rigid.html#valis.serial_non_rigid.SerialNonRigidRegistrar.summarize">[docs]</a>    <span class="k">def</span> <span class="nf">summarize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Summarize alignment error</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        summary_df: Dataframe</span>
<span class="sd">            Pandas dataframe containin the registration error of the</span>
<span class="sd">            alignment between each image and the previous one in the stack.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">src_img_names</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span>
        <span class="n">dst_img_names</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span>
        <span class="n">shape_list</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span>

        <span class="n">og_med_d_list</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span>
        <span class="n">og_tre_list</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span>
        <span class="n">med_d_list</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span>
        <span class="n">tre_list</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span>

        <span class="n">src_img_names</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_img_idx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_img_name</span>
        <span class="n">shape_list</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_img_idx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_rigid_obj_list</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_img_idx</span><span class="p">]</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span>

        <span class="n">iter_order</span> <span class="o">=</span> <span class="n">warp_tools</span><span class="o">.</span><span class="n">get_alignment_indices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_img_idx</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">======== Summarizing registration</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">moving_idx</span><span class="p">,</span> <span class="n">fixed_idx</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">iter_order</span><span class="p">):</span>
            <span class="n">moving_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_rigid_obj_list</span><span class="p">[</span><span class="n">moving_idx</span><span class="p">]</span>
            <span class="n">fixed_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_rigid_obj_list</span><span class="p">[</span><span class="n">fixed_idx</span><span class="p">]</span>
            <span class="n">src_img_names</span><span class="p">[</span><span class="n">moving_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">moving_obj</span><span class="o">.</span><span class="n">name</span>
            <span class="n">dst_img_names</span><span class="p">[</span><span class="n">moving_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">fixed_obj</span><span class="o">.</span><span class="n">name</span>
            <span class="n">shape_list</span><span class="p">[</span><span class="n">moving_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">moving_obj</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span>

            <span class="n">og_tre_list</span><span class="p">[</span><span class="n">moving_idx</span><span class="p">],</span> <span class="n">og_med_d_list</span><span class="p">[</span><span class="n">moving_idx</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">warp_tools</span><span class="o">.</span><span class="n">measure_error</span><span class="p">(</span><span class="n">moving_obj</span><span class="o">.</span><span class="n">moving_xy</span><span class="p">,</span>
                                         <span class="n">moving_obj</span><span class="o">.</span><span class="n">fixed_xy</span><span class="p">,</span>
                                         <span class="n">moving_obj</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

            <span class="n">warped_moving_xy</span> <span class="o">=</span> <span class="n">warp_tools</span><span class="o">.</span><span class="n">warp_xy</span><span class="p">(</span><span class="n">moving_obj</span><span class="o">.</span><span class="n">moving_xy</span><span class="p">,</span>
                                                  <span class="n">M</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                  <span class="n">fwd_dxdy</span><span class="o">=</span><span class="n">moving_obj</span><span class="o">.</span><span class="n">fwd_dxdy</span><span class="p">)</span>

            <span class="n">warped_fixed_xy</span> <span class="o">=</span> <span class="n">warp_tools</span><span class="o">.</span><span class="n">warp_xy</span><span class="p">(</span><span class="n">moving_obj</span><span class="o">.</span><span class="n">fixed_xy</span><span class="p">,</span>
                                                 <span class="n">M</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                 <span class="n">fwd_dxdy</span><span class="o">=</span><span class="n">moving_obj</span><span class="o">.</span><span class="n">fwd_dxdy</span><span class="p">)</span>

            <span class="n">tre_list</span><span class="p">[</span><span class="n">moving_idx</span><span class="p">],</span> <span class="n">med_d_list</span><span class="p">[</span><span class="n">moving_idx</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">warp_tools</span><span class="o">.</span><span class="n">measure_error</span><span class="p">(</span><span class="n">warped_moving_xy</span><span class="p">,</span>
                                         <span class="n">warped_fixed_xy</span><span class="p">,</span>
                                         <span class="n">moving_obj</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="n">summary_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="n">src_img_names</span><span class="p">,</span>
            <span class="s2">&quot;to&quot;</span><span class="p">:</span> <span class="n">dst_img_names</span><span class="p">,</span>
            <span class="s2">&quot;original_D&quot;</span><span class="p">:</span> <span class="n">og_med_d_list</span><span class="p">,</span>
            <span class="s2">&quot;D&quot;</span><span class="p">:</span> <span class="n">med_d_list</span><span class="p">,</span>
            <span class="s2">&quot;original_TRE&quot;</span><span class="p">:</span> <span class="n">og_tre_list</span><span class="p">,</span>
            <span class="s2">&quot;TRE&quot;</span><span class="p">:</span> <span class="n">tre_list</span><span class="p">,</span>
            <span class="s2">&quot;shape&quot;</span><span class="p">:</span> <span class="n">shape_list</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="n">to_summarize_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_img_idx</span><span class="p">]</span>
        <span class="n">summary_df</span><span class="p">[</span><span class="s2">&quot;series_d&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">warp_tools</span><span class="o">.</span><span class="n">calc_total_error</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">med_d_list</span><span class="p">)[</span><span class="n">to_summarize_idx</span><span class="p">])</span>
        <span class="n">summary_df</span><span class="p">[</span><span class="s2">&quot;series_tre&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">warp_tools</span><span class="o">.</span><span class="n">calc_total_error</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tre_list</span><span class="p">)[</span><span class="n">to_summarize_idx</span><span class="p">])</span>
        <span class="n">summary_df</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">summary_df</span> <span class="o">=</span> <span class="n">summary_df</span>

        <span class="k">return</span> <span class="n">summary_df</span></div></div>


<div class="viewcode-block" id="register_images"><a class="viewcode-back" href="../../serial_non_rigid.html#valis.serial_non_rigid.register_images">[docs]</a><span class="k">def</span> <span class="nf">register_images</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">non_rigid_reg_class</span><span class="o">=</span><span class="n">non_rigid_registrars</span><span class="o">.</span><span class="n">OpticalFlowWarper</span><span class="p">,</span>
                    <span class="n">non_rigid_reg_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dst_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">reference_img_f</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">moving_to_fixed_xy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">align_to_reference</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">img_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compose_transforms</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">qt_emitter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src : SerialRigidRegistrar, str</span>
<span class="sd">        Either a SerialRigidRegistrar object that was used to optimally</span>
<span class="sd">        align a series of images, or a string indicating where the images</span>
<span class="sd">        to be aligned are located. If src is a string, the images should be</span>
<span class="sd">        named such that they are read in the correct order, i.e. each</span>
<span class="sd">        starting with a number.</span>

<span class="sd">    non_rigid_reg_class : NonRigidRegistrar</span>
<span class="sd">        Uninstantiated NonRigidRegistrar class that will be used to</span>
<span class="sd">        calculate the deformation fields between images.</span>
<span class="sd">        By default this is an OpticalFlowWarper that uses the OpenCV</span>
<span class="sd">        implementation of DeepFlow.</span>

<span class="sd">    non_rigid_reg_params: dictionary, optional</span>
<span class="sd">        Dictionary containing parameters {name: value} to be used to initialize</span>
<span class="sd">        the NonRigidRegistrar.</span>
<span class="sd">        In the case where simple ITK is used by the, params should be</span>
<span class="sd">        a SimpleITK.ParameterMap. Note that numeric values nedd to be</span>
<span class="sd">        converted to strings.</span>

<span class="sd">    dst_dir : str, optional</span>
<span class="sd">        Top directory where aliged images should be save. SerialNonRigidRegistrar will</span>
<span class="sd">        be in this folder, and aligned images in the &quot;registered_images&quot;</span>
<span class="sd">        sub-directory. If None, the images will not be written to file</span>

<span class="sd">    reference_img_f : str, optional</span>
<span class="sd">        Filename of image that will be treated as the center of the stack.</span>
<span class="sd">        If None, the index of the middle image will be returned.</span>

<span class="sd">    moving_to_fixed_xy :  dict of list, or bool</span>
<span class="sd">        If `moving_to_fixed_xy` is a dict of list, then</span>
<span class="sd">        Key = image name, value = list of matched keypoints between</span>
<span class="sd">        each moving image and the fixed image.</span>
<span class="sd">        Each element in the list contains 2 arrays:</span>

<span class="sd">        #. Rigid registered xy in moving/current/from image</span>
<span class="sd">        #. Rigid registered xy in fixed/next/to image</span>

<span class="sd">        To deterime which pairs of images will be aligned, use</span>
<span class="sd">        `warp_tools.get_alignment_indices`. Can use `get_imgs_from_dir`</span>
<span class="sd">        to see the order inwhich the images will be read, which will correspond</span>
<span class="sd">        to the indices retuned by `warp_tools.get_alignment_indices`.</span>

<span class="sd">        If `src` is a SerialRigidRegistrar and `moving_to_fixed_xy` is</span>
<span class="sd">        True, then the matching features in the SerialRigidRegistrar will</span>
<span class="sd">        be used. If False, then matching features will not be used.</span>

<span class="sd">    mask :  ndarray, bool, optional</span>
<span class="sd">        Mask used in non-rigid alignments.</span>

<span class="sd">        If an ndarray, it must have the same size as the other images.</span>

<span class="sd">        If True, then the `overlap_mask` in the SerialRigidRegistrar</span>
<span class="sd">        will be used.</span>

<span class="sd">        If False or None, no mask will be used.</span>

<span class="sd">    name : optional</span>
<span class="sd">        Optional name for this SerialNonRigidRegistrar</span>

<span class="sd">    align_to_reference : bool, optional</span>
<span class="sd">        Whether or not images should be aligne to a reference image</span>
<span class="sd">        specified by `reference_img_f`. Will be set to True if</span>
<span class="sd">        `reference_img_f` is provided.</span>

<span class="sd">    img_params : dict, optional</span>
<span class="sd">        Dictionary of parameters to be used for each particular image.</span>
<span class="sd">        Useful if images to be registered haven&#39;t been processed.</span>
<span class="sd">        Will be passed to `non_rigid_reg_class` init and register functions.</span>
<span class="sd">        key = file name, value= dictionary of keyword arguments and values</span>

<span class="sd">    qt_emitter : PySide2.QtCore.Signal, optional</span>
<span class="sd">        Used to emit signals that update the GUI&#39;s progress bars</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    nr_reg : SerialNonRigidRegistrar</span>
<span class="sd">        SerialNonRigidRegistrar that has registeredt the images in `src`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
    <span class="n">nr_reg</span> <span class="o">=</span> <span class="n">SerialNonRigidRegistrar</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="n">src</span><span class="p">,</span> <span class="n">reference_img_f</span><span class="o">=</span><span class="n">reference_img_f</span><span class="p">,</span>
                                     <span class="n">moving_to_fixed_xy</span><span class="o">=</span><span class="n">moving_to_fixed_xy</span><span class="p">,</span>
                                     <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                                     <span class="n">align_to_reference</span><span class="o">=</span><span class="n">align_to_reference</span><span class="p">,</span>
                                     <span class="n">compose_transforms</span><span class="o">=</span><span class="n">compose_transforms</span><span class="p">)</span>

    <span class="n">nr_reg</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">non_rigid_reg_class</span><span class="p">,</span> <span class="n">non_rigid_reg_params</span><span class="p">,</span> <span class="n">img_params</span><span class="o">=</span><span class="n">img_params</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">dst_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">registered_img_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst_dir</span><span class="p">,</span> <span class="s2">&quot;non_rigid_registered_images&quot;</span><span class="p">)</span>
        <span class="n">registered_data_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst_dir</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">)</span>
        <span class="n">registered_grids_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst_dir</span><span class="p">,</span> <span class="s2">&quot;deformation_grids&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="p">[</span><span class="n">registered_img_dir</span><span class="p">,</span> <span class="n">registered_data_dir</span><span class="p">,</span> <span class="n">registered_grids_dir</span><span class="p">]:</span>
            <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">======== Saving results</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">moving_to_fixed_xy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">summary_df</span> <span class="o">=</span> <span class="n">nr_reg</span><span class="o">.</span><span class="n">summarize</span><span class="p">()</span>
            <span class="n">summary_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">registered_data_dir</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_results.csv&quot;</span><span class="p">)</span>
            <span class="n">summary_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">summary_file</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">pickle_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">registered_data_dir</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_non_rigid_registrar.pickle&quot;</span><span class="p">)</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">nr_reg</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">pickle_file</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">img_obj</span> <span class="ow">in</span> <span class="n">nr_reg</span><span class="o">.</span><span class="n">non_rigid_obj_list</span><span class="p">:</span>
            <span class="n">f_out</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">img_obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.png&quot;</span>

            <span class="n">io</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">registered_img_dir</span><span class="p">,</span> <span class="n">f_out</span><span class="p">),</span>
                      <span class="n">img_obj</span><span class="o">.</span><span class="n">registered_img</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span>

            <span class="n">colord_tri_grid</span> <span class="o">=</span> <span class="n">viz</span><span class="o">.</span><span class="n">color_displacement_tri_grid</span><span class="p">(</span><span class="n">img_obj</span><span class="o">.</span><span class="n">bk_dxdy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                              <span class="n">img_obj</span><span class="o">.</span><span class="n">bk_dxdy</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

            <span class="n">io</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">registered_grids_dir</span><span class="p">,</span> <span class="n">f_out</span><span class="p">),</span> <span class="n">colord_tri_grid</span><span class="p">)</span>

    <span class="n">toc</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
    <span class="n">elapsed</span> <span class="o">=</span> <span class="n">toc</span> <span class="o">-</span> <span class="n">tic</span>
    <span class="n">time_string</span><span class="p">,</span> <span class="n">time_units</span> <span class="o">=</span> <span class="n">valtils</span><span class="o">.</span><span class="n">get_elapsed_time_string</span><span class="p">(</span><span class="n">elapsed</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">======== Non-rigid registration complete in </span><span class="si">{</span><span class="n">time_string</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">time_units</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">nr_reg</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2022, Chandler Gatenbee.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>