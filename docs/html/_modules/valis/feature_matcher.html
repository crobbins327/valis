

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>valis.feature_matcher &mdash; valis &#34;1.0.0rc11&#34;
 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: black" >
          

          
            <a href="../../index.html">
          

          
            
            <img src="../../_static/valis_logo_black_no_bg.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../registration.html">Registration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../slide_io.html">Slide I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../preprocessing.html">Image pre-processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../feature_detectors.html">Feature detectors and descriptors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../feature_matcher.html">Feature matching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../affine_optimizer.html">Affine optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../non_rigid_registrars.html">Non-rigid registration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../serial_rigid.html">Serial rigid registration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../serial_non_rigid.html">Serial non-rigid registration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../viz.html">Visualization</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">valis</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>valis.feature_matcher</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for valis.feature_matcher</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Functions and classes to match and filter image features</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">numba</span> <span class="k">as</span> <span class="nn">nba</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">metrics</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics.pairwise</span> <span class="kn">import</span> <span class="n">pairwise_kernels</span>
<span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="n">transform</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">warp_tools</span>

<span class="n">AMBIGUOUS_METRICS</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">metrics</span><span class="o">.</span><span class="n">pairwise</span><span class="o">.</span><span class="n">_VALID_METRICS</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span>
    <span class="n">metrics</span><span class="o">.</span><span class="n">pairwise</span><span class="o">.</span><span class="n">PAIRWISE_KERNEL_FUNCTIONS</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="sd">&quot;&quot;&quot;set:</span>
<span class="sd">    Metrics found in both the valid metrics ang kernel methods in</span>
<span class="sd">    sklearn.metrics.pairwise. Issue is that metrics are distances,</span>
<span class="sd">    while kernels are similarities. Metrics in this set are assumed</span>
<span class="sd">    to be distaces, unless the metric_type parameter in match_descriptors</span>
<span class="sd">    is set to &quot;similarity&quot;. &quot;&quot;&quot;</span>


<span class="n">EPS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span>
<span class="sd">&quot;&quot;&quot;float: epsilon error to avoid division by 0&quot;&quot;&quot;</span>

<span class="n">GMS_NAME</span> <span class="o">=</span> <span class="s2">&quot;GMS&quot;</span>
<span class="sd">&quot;&quot;&quot;str: If filter_method parameter in match_desc_and_kp is set to this,</span>
<span class="sd">    Grid-based Motion Statistics will be used to remove poor matches&quot;&quot;&quot;</span>

<span class="n">RANSAC_NAME</span> <span class="o">=</span> <span class="s2">&quot;RANSAC&quot;</span>
<span class="sd">&quot;&quot;&quot;str: If filter_method parameter in match_desc_and_kp is set to this,</span>
<span class="sd">RANSAC will be used to remove poor matches</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">DEFAULT_MATCH_FILTER</span> <span class="o">=</span> <span class="n">RANSAC_NAME</span>
<span class="sd">&quot;&quot;&quot;str: The defulat filter_method value, either RANSAC_NAME or GMS_NAME&quot;&quot;&quot;</span>

<span class="n">DEFAULT_RANSAC</span> <span class="o">=</span> <span class="mi">7</span>
<span class="sd">&quot;&quot;&quot;int: Default RANSAC threshold&quot;&quot;&quot;</span>


<span class="nd">@nba</span><span class="o">.</span><span class="n">njit</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">convert_distance_to_similarity</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">n_features</span><span class="o">=</span><span class="mi">64</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert distance to similarity</span>
<span class="sd">    Based on https://scikit-learn.org/stable/modules/metrics.html</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    d : float</span>
<span class="sd">        Value to convert</span>

<span class="sd">    n_features: int</span>
<span class="sd">        Number of features used to calcuate distance.</span>
<span class="sd">        Only needed when calc == 0</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    y : float</span>
<span class="sd">        Similarity</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">d</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">n_features</span><span class="p">))</span>


<span class="nd">@nba</span><span class="o">.</span><span class="n">njit</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">convert_similarity_to_distance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">n_features</span><span class="o">=</span><span class="mi">64</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert similarity to distance</span>

<span class="sd">    Based on https://scikit-learn.org/stable/modules/metrics.html</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    s : float</span>
<span class="sd">        Similarity to convert</span>

<span class="sd">    n_features: int</span>
<span class="sd">        Number of features used to calcuate similarity.</span>
<span class="sd">        Only needed when calc == 0</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    y : float</span>
<span class="sd">        Distance</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">s</span> <span class="o">+</span> <span class="n">EPS</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">n_features</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">filter_matches_ransac</span><span class="p">(</span><span class="n">kp1_xy</span><span class="p">,</span> <span class="n">kp2_xy</span><span class="p">,</span> <span class="n">ransac_val</span><span class="o">=</span><span class="n">DEFAULT_RANSAC</span><span class="p">):</span>
    <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Remove poor matches using RANSAC</span>

<span class="s2">    Parameters</span>
<span class="s2">    ----------</span>
<span class="s2">    kp1_xy : ndarray</span>
<span class="s2">        (N, 2) array containing image 1s keypoint positions, in xy coordinates.</span>

<span class="s2">    kp2_xy : ndarray</span>
<span class="s2">        (N, 2) array containing image 2s keypoint positions, in xy coordinates.</span>

<span class="s2">    ransac_val: int</span>
<span class="s2">        RANSAC threshold, passed to cv2.findHomography as the</span>
<span class="s2">        ransacReprojThreshold parameter. Default value is </span><span class="si">{</span><span class="n">DEFAULT_RANSAC</span><span class="si">}</span><span class="s2"></span>

<span class="s2">    Returns</span>
<span class="s2">    -------</span>
<span class="s2">    filtered_src_points : (N, 2) array</span>
<span class="s2">        Inlier keypoints from kp1_xy</span>

<span class="s2">    filtered_dst_points : (N, 2) array</span>
<span class="s2">        Inlier keypoints from kp1_xy</span>

<span class="s2">    good_idx : (1, N) array</span>
<span class="s2">        Indices of inliers</span>

<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">findHomography</span><span class="p">(</span><span class="n">kp1_xy</span><span class="p">,</span> <span class="n">kp2_xy</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">RANSAC</span><span class="p">,</span> <span class="n">ransac_val</span><span class="p">)</span>
    <span class="n">good_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">filtered_src_points</span> <span class="o">=</span> <span class="n">kp1_xy</span><span class="p">[</span><span class="n">good_idx</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">filtered_dst_points</span> <span class="o">=</span> <span class="n">kp2_xy</span><span class="p">[</span><span class="n">good_idx</span><span class="p">,</span> <span class="p">:]</span>
    <span class="k">return</span> <span class="n">filtered_src_points</span><span class="p">,</span> <span class="n">filtered_dst_points</span><span class="p">,</span> <span class="n">good_idx</span>


<span class="k">def</span> <span class="nf">filter_matches_gms</span><span class="p">(</span><span class="n">kp1_xy</span><span class="p">,</span> <span class="n">kp2_xy</span><span class="p">,</span> <span class="n">feature_d</span><span class="p">,</span> <span class="n">img1_shape</span><span class="p">,</span> <span class="n">img2_shape</span><span class="p">,</span>
                       <span class="n">scaling</span><span class="p">,</span> <span class="n">thresholdFactor</span><span class="o">=</span><span class="mf">6.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Filter matches using GMS (Grid-based Motion Statistics) [1]</span>

<span class="sd">    This filtering method does best when there are a large number of features,</span>
<span class="sd">    so the ORB detector is recommended</span>

<span class="sd">    Note that this function assumes the keypoints and distances have been</span>
<span class="sd">    sorted such that each keypoint in kp1_xy has the same index as the</span>
<span class="sd">    matching keypoint in kp2_xy andd corresponding feautre distance in</span>
<span class="sd">    feature_d. For example, kp1_xy[0] should have the corresponding keypoint</span>
<span class="sd">    at kp2_xy[0] and the corresponding feature distance at feature_d[0].</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    kp1_xy : ndarray</span>
<span class="sd">        (N, 2) array with image 1s keypoint positions, in xy coordinates, for</span>
<span class="sd">        each of the N matched descriptors in desc1</span>

<span class="sd">    kp2_xy : narray</span>
<span class="sd">        (N, 2) array with image 2s keypoint positions, in xy coordinates, for</span>
<span class="sd">        each of the N matched descriptors in desc2</span>

<span class="sd">    feature_d: ndarray</span>
<span class="sd">        Feature distances between corresponding keypoints</span>

<span class="sd">    img1_shape: tuple</span>
<span class="sd">        Shape of image 1 (row, col)</span>

<span class="sd">    img2_shape: tuple</span>
<span class="sd">        Shape of image 2 (row, col)</span>

<span class="sd">    scaling: bool</span>
<span class="sd">        Whether or not image scaling should be considered</span>

<span class="sd">    thresholdFactor: float</span>
<span class="sd">        The higher, the fewer matches</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    filtered_src_points : (N, 2) array</span>
<span class="sd">        Inlier keypoints from kp1_xy</span>

<span class="sd">    filtered_dst_points : (N, 2) array</span>
<span class="sd">        Inlier keypoints from kp1_xy</span>

<span class="sd">    good_idx : (1, N) array</span>
<span class="sd">        Indices of inliers</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    .. [1] JiaWang Bian, Wen-Yan Lin, Yasuyuki Matsushita, Sai-Kit Yeung,</span>
<span class="sd">    Tan Dat Nguyen, and Ming-Ming Cheng. Gms: Grid-based motion statistics for</span>
<span class="sd">    fast, ultra-robust feature correspondence. In IEEE Conference on Computer</span>
<span class="sd">    Vision and Pattern Recognition, 2017</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">kp1</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">KeyPoint_convert</span><span class="p">(</span><span class="n">kp1_xy</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
    <span class="n">kp2</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">KeyPoint_convert</span><span class="p">(</span><span class="n">kp2_xy</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
    <span class="n">matches</span> <span class="o">=</span> <span class="p">[</span><span class="n">cv2</span><span class="o">.</span><span class="n">DMatch</span><span class="p">(</span><span class="n">_queryIdx</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">_trainIdx</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">_imgIdx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">_distance</span><span class="o">=</span><span class="n">feature_d</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">kp1_xy</span><span class="p">))]</span>
    <span class="n">gms_matches</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">xfeatures2d</span><span class="o">.</span><span class="n">matchGMS</span><span class="p">(</span><span class="n">img1_shape</span><span class="p">,</span> <span class="n">img2_shape</span><span class="p">,</span> <span class="n">kp1</span><span class="p">,</span> <span class="n">kp2</span><span class="p">,</span> <span class="n">matches</span><span class="p">,</span> <span class="n">withRotation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                           <span class="n">withScale</span><span class="o">=</span><span class="n">scaling</span><span class="p">,</span> <span class="n">thresholdFactor</span><span class="o">=</span><span class="n">thresholdFactor</span><span class="p">)</span>
    <span class="n">good_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">d</span><span class="o">.</span><span class="n">queryIdx</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">gms_matches</span><span class="p">])</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">good_idx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">filtered_src_points</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">filtered_dst_points</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">filtered_src_points</span> <span class="o">=</span> <span class="n">kp1_xy</span><span class="p">[</span><span class="n">good_idx</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">filtered_dst_points</span> <span class="o">=</span> <span class="n">kp2_xy</span><span class="p">[</span><span class="n">good_idx</span><span class="p">,</span> <span class="p">:]</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">filtered_src_points</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">filtered_dst_points</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">good_idx</span><span class="p">)</span>



<span class="k">def</span> <span class="nf">filter_matches_tukey</span><span class="p">(</span><span class="n">src_xy</span><span class="p">,</span> <span class="n">dst_xy</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Detect and remove outliers using Tukey&#39;s method</span>
<span class="sd">    Adapted from https://towardsdatascience.com/detecting-and-treating-outliers-in-python-part-1-4ece5098b755</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src_xy : ndarray</span>
<span class="sd">        (N, 2) array containing image 1s keypoint positions, in xy coordinates.</span>

<span class="sd">    dst_xy : ndarray</span>
<span class="sd">        (N, 2) array containing image 2s keypoint positions, in xy coordinates.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    filtered_src_points : (N, 2) array</span>
<span class="sd">        Inlier keypoints from kp1_xy</span>

<span class="sd">    filtered_dst_points : (N, 2) array</span>
<span class="sd">        Inlier keypoints from kp1_xy</span>

<span class="sd">    good_idx : (1, N) array</span>
<span class="sd">        Indices of inliers</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">tform</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">SimilarityTransform</span><span class="p">()</span>
    <span class="n">tform</span><span class="o">.</span><span class="n">estimate</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="n">dst_xy</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">src_xy</span><span class="p">)</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">tform</span><span class="o">.</span><span class="n">params</span>

    <span class="n">warped_xy</span> <span class="o">=</span> <span class="n">warp_tools</span><span class="o">.</span><span class="n">warp_xy</span><span class="p">(</span><span class="n">src_xy</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">warp_tools</span><span class="o">.</span><span class="n">calc_d</span><span class="p">(</span><span class="n">warped_xy</span><span class="p">,</span>  <span class="n">dst_xy</span><span class="p">)</span>

    <span class="n">q1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">)</span>
    <span class="n">q3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">)</span>
    <span class="n">iqr</span> <span class="o">=</span> <span class="n">q3</span><span class="o">-</span><span class="n">q1</span>
    <span class="n">inner_fence</span> <span class="o">=</span> <span class="mf">1.5</span><span class="o">*</span><span class="n">iqr</span>
    <span class="n">outer_fence</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">iqr</span>

    <span class="c1">#inner fence lower and upper end</span>
    <span class="n">inner_fence_le</span> <span class="o">=</span> <span class="n">q1</span><span class="o">-</span><span class="n">inner_fence</span>
    <span class="n">inner_fence_ue</span> <span class="o">=</span> <span class="n">q3</span><span class="o">+</span><span class="n">inner_fence</span>

    <span class="c1">#outer fence lower and upper end</span>
    <span class="n">outer_fence_le</span> <span class="o">=</span> <span class="n">q1</span><span class="o">-</span><span class="n">outer_fence</span>
    <span class="n">outer_fence_ue</span> <span class="o">=</span> <span class="n">q3</span><span class="o">+</span><span class="n">outer_fence</span>

    <span class="n">outliers_prob</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">outliers_poss</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">inliers_prob</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">inliers_poss</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">v</span> <span class="o">&lt;=</span> <span class="n">outer_fence_le</span> <span class="ow">or</span> <span class="n">v</span> <span class="o">&gt;=</span> <span class="n">outer_fence_ue</span><span class="p">:</span>
            <span class="n">outliers_prob</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">inliers_prob</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">v</span> <span class="o">&lt;=</span> <span class="n">inner_fence_le</span> <span class="ow">or</span> <span class="n">v</span> <span class="o">&gt;=</span> <span class="n">inner_fence_ue</span><span class="p">:</span>
            <span class="n">outliers_poss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">inliers_poss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

    <span class="n">src_xy_inlier</span> <span class="o">=</span> <span class="n">src_xy</span><span class="p">[</span><span class="n">inliers_prob</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">dst_xy_inlier</span> <span class="o">=</span> <span class="n">dst_xy</span><span class="p">[</span><span class="n">inliers_prob</span><span class="p">,</span> <span class="p">:]</span>

    <span class="k">return</span> <span class="n">src_xy_inlier</span><span class="p">,</span> <span class="n">dst_xy_inlier</span><span class="p">,</span> <span class="n">inliers_prob</span>


<div class="viewcode-block" id="filter_matches"><a class="viewcode-back" href="../../feature_matcher.html#valis.feature_matcher.filter_matches">[docs]</a><span class="k">def</span> <span class="nf">filter_matches</span><span class="p">(</span><span class="n">kp1_xy</span><span class="p">,</span> <span class="n">kp2_xy</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">DEFAULT_MATCH_FILTER</span><span class="p">,</span>
                   <span class="n">filtering_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Use RANSAC or GMS to remove poor matches</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    kp1_xy : ndarray</span>
<span class="sd">        (N, 2) array containing image 1s keypoint positions, in xy coordinates.</span>

<span class="sd">    kp2_xy : ndarray</span>
<span class="sd">        (N, 2) array containing image 2s keypoint positions, in xy coordinates.</span>

<span class="sd">    method: str</span>
<span class="sd">        `method` = &quot;GMS&quot; will use filter_matches_gms() to remove poor matches.</span>
<span class="sd">        This uses the Grid-based Motion Statistics.</span>
<span class="sd">        `method` = &quot;RANSAC&quot; will use RANSAC to remove poor matches</span>

<span class="sd">    filtering_kwargs: dict</span>
<span class="sd">        Extra arguments passed to filtering function</span>

<span class="sd">        If `method` == &quot;GMS&quot;, these need to include: img1_shape, img2_shape,</span>
<span class="sd">        scaling, thresholdFactor. See filter_matches_gms for details</span>

<span class="sd">        If `method` == &quot;RANSAC&quot;, this can be None, since the ransac value is</span>
<span class="sd">        a class attribute</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    filtered_src_points : ndarray</span>
<span class="sd">        (M, 2) ndarray of inlier keypoints from kp1_xy</span>

<span class="sd">    filtered_dst_points : (N, 2) array</span>
<span class="sd">        (M, 2) ndarray of inlier keypoints from kp2_xy</span>

<span class="sd">    good_idx : ndarray</span>
<span class="sd">        (M, 1) array containing ndices of inliers</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">all_matching_args</span> <span class="o">=</span> <span class="n">filtering_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">all_matching_args</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;kp1_xy&quot;</span><span class="p">:</span> <span class="n">kp1_xy</span><span class="p">,</span> <span class="s2">&quot;kp2_xy&quot;</span><span class="p">:</span> <span class="n">kp2_xy</span><span class="p">})</span>
    <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">GMS_NAME</span><span class="p">:</span>
        <span class="n">filter_fxn</span> <span class="o">=</span> <span class="n">filter_matches_gms</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">filter_fxn</span> <span class="o">=</span> <span class="n">filter_matches_ransac</span>

    <span class="n">filtered_src_points</span><span class="p">,</span> <span class="n">filtered_dst_points</span><span class="p">,</span> <span class="n">good_idx</span> <span class="o">=</span> <span class="n">filter_fxn</span><span class="p">(</span><span class="o">**</span><span class="n">all_matching_args</span><span class="p">)</span>

    <span class="c1"># Do additional filtering to remove other outliers that may have been missed by RANSAC</span>
    <span class="n">filtered_src_points</span><span class="p">,</span> <span class="n">filtered_dst_points</span><span class="p">,</span> <span class="n">good_idx</span> <span class="o">=</span> <span class="n">filter_matches_tukey</span><span class="p">(</span><span class="n">filtered_src_points</span><span class="p">,</span> <span class="n">filtered_dst_points</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">filtered_src_points</span><span class="p">,</span> <span class="n">filtered_dst_points</span><span class="p">,</span> <span class="n">good_idx</span></div>


<span class="k">def</span> <span class="nf">match_descriptors</span><span class="p">(</span><span class="n">descriptors1</span><span class="p">,</span> <span class="n">descriptors2</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">metric_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">max_distance</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
                      <span class="n">cross_check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_ratio</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">metric_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Brute-force matching of descriptors</span>

<span class="sd">    For each descriptor in the first set this matcher finds the closest</span>
<span class="sd">    descriptor in the second set (and vice-versa in the case of enabled</span>
<span class="sd">    cross-checking).</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    descriptors1 : ndarray</span>
<span class="sd">        (M, P) array of descriptors of size P about M keypoints in image 1.</span>

<span class="sd">    descriptors2 : ndarray</span>
<span class="sd">        (N, P) array of descriptors of size P about N keypoints in image 2.</span>

<span class="sd">    metric : string or callable</span>
<span class="sd">        Distance metrics used in spatial.distance.cdist() or sklearn.metrics.pairwise()</span>
<span class="sd">        Alterntively, can also use similarity metrics in sklearn.metrics.pairwise.PAIRWISE_KERNEL_FUNCTIONS.</span>
<span class="sd">        By default the L2-norm is used for all descriptors of dtype float or</span>
<span class="sd">        double and the Hamming distance is used for binary descriptors automatically.</span>

<span class="sd">    p : int, optional</span>
<span class="sd">        The p-norm to apply for ``metric=&#39;minkowski&#39;``.</span>

<span class="sd">    max_distance : float, optional</span>
<span class="sd">        Maximum allowed distance between descriptors of two keypoints</span>
<span class="sd">        in separate images to be regarded as a match.</span>

<span class="sd">    cross_check : bool, optional</span>
<span class="sd">        If True, the matched keypoints are returned after cross checking i.e. a</span>
<span class="sd">        matched pair (keypoint1, keypoint2) is returned if keypoint2 is the</span>
<span class="sd">        best match for keypoint1 in second image and keypoint1 is the best</span>
<span class="sd">        match for keypoint2 in first image.</span>

<span class="sd">    max_ratio : float, optional</span>
<span class="sd">        Maximum ratio of distances between first and second closest descriptor</span>
<span class="sd">        in the second set of descriptors. This threshold is useful to filter</span>
<span class="sd">        ambiguous matches between the two descriptor sets. The choice of this</span>
<span class="sd">        value depends on the statistics of the chosen descriptor, e.g.,</span>
<span class="sd">        for SIFT descriptors a value of 0.8 is usually chosen, see</span>
<span class="sd">        D.G. Lowe, &quot;Distinctive Image Features from Scale-Invariant Keypoints&quot;,</span>
<span class="sd">        International Journal of Computer Vision, 2004.</span>

<span class="sd">    metric_kwargs : dict</span>
<span class="sd">        Optionl keyword arguments to be passed into pairwise_distances() or pairwise_kernels()</span>
<span class="sd">        from the sklearn.metrics.pairwise module</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    matches : (Q, 2) array</span>
<span class="sd">        Indices of corresponding matches in first and second set of</span>
<span class="sd">        descriptors, where ``matches[:, 0]`` denote the indices in the first</span>
<span class="sd">        and ``matches[:, 1]`` the indices in the second set of descriptors.</span>

<span class="sd">    distances : (Q, 1) array</span>
<span class="sd">        Distance values between each pair of matched descriptor</span>

<span class="sd">    metric_name : str or function</span>
<span class="sd">        Name metric used to calculate distances or similarity</span>

<span class="sd">    NOTE</span>
<span class="sd">    ----</span>
<span class="sd">    Modified from scikit-image to use scikit-learn&#39;s distance and kernal methods.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">descriptors1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">descriptors2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Descriptor length must equal.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">metric</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">descriptors1</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">):</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="s1">&#39;hamming&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="s1">&#39;euclidean&#39;</span>

    <span class="k">if</span> <span class="n">metric_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">metric_kwargs</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;minkowski&#39;</span><span class="p">:</span>
        <span class="n">metric_kwargs</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span>

    <span class="k">if</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">AMBIGUOUS_METRICS</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;metric&quot;</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="s2">&quot;could be a distance in pairwise_distances() or similarity in pairwise_kernels().&quot;</span><span class="p">,</span>
              <span class="s2">&quot;Please set metric_type. Otherwise, metric is assumed to be a distance&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span> <span class="ow">or</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">pairwise</span><span class="o">.</span><span class="n">_VALID_METRICS</span><span class="p">:</span>

        <span class="n">distances</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">pairwise_distances</span><span class="p">(</span><span class="n">descriptors1</span><span class="p">,</span> <span class="n">descriptors2</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span> <span class="o">**</span><span class="n">metric_kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span> <span class="ow">and</span> <span class="n">metric_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="ne">Warning</span><span class="p">(</span><span class="s2">&quot;Metric passed as a function or class, but the metric type not provided&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;Assuming the metric function returns a distance. If a similarity is actually returned&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;set metric_type = &#39;similiarity&#39;. If metric is a distance, set metric_type = &#39;distance&#39;&quot;</span>
                          <span class="s2">&quot;to avoid this message&quot;</span><span class="p">))</span>

            <span class="n">metric_type</span> <span class="o">=</span> <span class="s2">&quot;distance&quot;</span>
        <span class="k">if</span> <span class="n">metric_type</span> <span class="o">==</span> <span class="s2">&quot;similarity&quot;</span><span class="p">:</span>
            <span class="n">distances</span> <span class="o">=</span> <span class="n">convert_similarity_to_distance</span><span class="p">(</span><span class="n">distances</span><span class="p">,</span> <span class="n">n_features</span><span class="o">=</span><span class="n">descriptors1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">pairwise</span><span class="o">.</span><span class="n">PAIRWISE_KERNEL_FUNCTIONS</span><span class="p">:</span>
        <span class="n">similarities</span> <span class="o">=</span> <span class="n">pairwise_kernels</span><span class="p">(</span><span class="n">descriptors1</span><span class="p">,</span> <span class="n">descriptors2</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span> <span class="o">**</span><span class="n">metric_kwargs</span><span class="p">)</span>
        <span class="n">distances</span> <span class="o">=</span> <span class="n">convert_similarity_to_distance</span><span class="p">(</span><span class="n">similarities</span><span class="p">,</span> <span class="n">n_features</span><span class="o">=</span><span class="n">descriptors1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">metric</span><span class="p">):</span>
        <span class="n">metric_name</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">metric_name</span> <span class="o">=</span> <span class="n">metric</span>

    <span class="n">indices1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">descriptors1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">indices2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">distances</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cross_check</span><span class="p">:</span>
        <span class="n">matches1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">distances</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">indices1</span> <span class="o">==</span> <span class="n">matches1</span><span class="p">[</span><span class="n">indices2</span><span class="p">]</span>
        <span class="n">indices1</span> <span class="o">=</span> <span class="n">indices1</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">indices2</span> <span class="o">=</span> <span class="n">indices2</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">max_distance</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">distances</span><span class="p">[</span><span class="n">indices1</span><span class="p">,</span> <span class="n">indices2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">max_distance</span>
        <span class="n">indices1</span> <span class="o">=</span> <span class="n">indices1</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">indices2</span> <span class="o">=</span> <span class="n">indices2</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">max_ratio</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
        <span class="n">best_distances</span> <span class="o">=</span> <span class="n">distances</span><span class="p">[</span><span class="n">indices1</span><span class="p">,</span> <span class="n">indices2</span><span class="p">]</span>
        <span class="n">distances</span><span class="p">[</span><span class="n">indices1</span><span class="p">,</span> <span class="n">indices2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="n">second_best_indices2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">distances</span><span class="p">[</span><span class="n">indices1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">second_best_distances</span> <span class="o">=</span> <span class="n">distances</span><span class="p">[</span><span class="n">indices1</span><span class="p">,</span> <span class="n">second_best_indices2</span><span class="p">]</span>
        <span class="n">second_best_distances</span><span class="p">[</span><span class="n">second_best_distances</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> \
            <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="n">best_distances</span> <span class="o">/</span> <span class="n">second_best_distances</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">ratio</span> <span class="o">&lt;</span> <span class="n">max_ratio</span>
        <span class="n">indices1</span> <span class="o">=</span> <span class="n">indices1</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">indices2</span> <span class="o">=</span> <span class="n">indices2</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">indices1</span><span class="p">,</span> <span class="n">indices2</span><span class="p">)),</span> <span class="n">best_distances</span><span class="p">[</span><span class="n">indices1</span><span class="p">,</span> <span class="n">indices2</span><span class="p">],</span> <span class="n">metric</span><span class="p">,</span> <span class="n">metric_type</span>
    <span class="k">else</span><span class="p">:</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">indices1</span><span class="p">,</span> <span class="n">indices2</span><span class="p">)),</span> <span class="n">distances</span><span class="p">[</span><span class="n">indices1</span><span class="p">,</span> <span class="n">indices2</span><span class="p">],</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">metric_type</span>


<div class="viewcode-block" id="match_desc_and_kp"><a class="viewcode-back" href="../../feature_matcher.html#valis.feature_matcher.match_desc_and_kp">[docs]</a><span class="k">def</span> <span class="nf">match_desc_and_kp</span><span class="p">(</span><span class="n">desc1</span><span class="p">,</span> <span class="n">kp1_xy</span><span class="p">,</span> <span class="n">desc2</span><span class="p">,</span> <span class="n">kp2_xy</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">metric_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metric_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">filter_method</span><span class="o">=</span><span class="n">DEFAULT_MATCH_FILTER</span><span class="p">,</span>
                      <span class="n">filtering_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Match the descriptors of image 1 with those of image 2 and remove outliers.</span>

<span class="sd">    Metric can be a string to use a distance in scipy.distnce.cdist(),</span>
<span class="sd">    or a custom distance function</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        desc1 : ndarray</span>
<span class="sd">            (N, P) array of image 1&#39;s descriptions for N keypoints,</span>
<span class="sd">            which each keypoint having P features</span>

<span class="sd">        kp1_xy : ndarray</span>
<span class="sd">            (N, 2) array containing image 1&#39;s keypoint positions (xy)</span>

<span class="sd">        desc2 : ndarray</span>
<span class="sd">            (M, P) array of image 2&#39;s descriptions for M keypoints,</span>
<span class="sd">            which each keypoint having P features</span>

<span class="sd">        kp2_xy : (M, 2) array</span>
<span class="sd">            (M, 2) array containing image 2&#39;s keypoint positions (xy)</span>

<span class="sd">        metric: string, or callable</span>
<span class="sd">            Metric to calculate distance between each pair of features</span>
<span class="sd">            in desc1 and desc2. Can be a string to use as distance in</span>
<span class="sd">            spatial.distance.cdist, or a custom distance function</span>

<span class="sd">        metric_kwargs : dict</span>
<span class="sd">            Optionl keyword arguments to be passed into pairwise_distances()</span>
<span class="sd">            or pairwise_kernels() from the sklearn.metrics.pairwise module</span>

<span class="sd">        filter_method: str</span>
<span class="sd">            &quot;GMS&quot; will use uses the Grid-based Motion Statistics</span>
<span class="sd">            &quot;RANSAC&quot; will use RANSAC</span>

<span class="sd">        filtering_kwargs: dict</span>
<span class="sd">            Dictionary containing extra arguments for the filtering method.</span>
<span class="sd">            kp1_xy, kp2_xy, feature_d are calculated here, and don&#39;t need to</span>
<span class="sd">            be in filtering_kwargs. If filter_method == &quot;GMS&quot;, then the</span>
<span class="sd">            required arguments are: img1_shape, img2_shape, scaling,</span>
<span class="sd">            thresholdFactor. See filter_matches_gms for details.</span>

<span class="sd">            If filter_method == &quot;RANSAC&quot;, then the required</span>
<span class="sd">            arguments are: ransac_val. See filter_matches_ransac for details.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        match_info12 : MatchInfo</span>
<span class="sd">                Contains information regarding the matches between image 1 and</span>
<span class="sd">                image 2. These results haven&#39;t undergone filtering, so</span>
<span class="sd">                contain many poor matches.</span>

<span class="sd">        filtered_match_info12 : MatchInfo</span>
<span class="sd">                Contains information regarding the matches between image 1 and</span>
<span class="sd">                image 2. These results have undergone filtering, and so</span>
<span class="sd">                contain good matches</span>

<span class="sd">        match_info21 : MatchInfo</span>
<span class="sd">                Contains information regarding the matches between image 2 and</span>
<span class="sd">                image 1. These results haven&#39;t undergone filtering, so contain</span>
<span class="sd">                many poor matches.</span>

<span class="sd">        filtered_match_info21 : MatchInfo</span>
<span class="sd">                Contains information regarding the matches between image 2 and</span>
<span class="sd">                image 1. These results have undergone filtering, and so contain</span>
<span class="sd">                good matches</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">metric_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">metric_kwargs</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">filter_method</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">GMS_NAME</span><span class="p">:</span>
        <span class="c1"># GMS is supposed to perform best with a large number of features #</span>
        <span class="n">cross_check</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cross_check</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">matches</span><span class="p">,</span> <span class="n">match_distances</span><span class="p">,</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">metric_type</span> <span class="o">=</span> \
        <span class="n">match_descriptors</span><span class="p">(</span><span class="n">desc1</span><span class="p">,</span> <span class="n">desc2</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span>
                          <span class="n">metric_type</span><span class="o">=</span><span class="n">metric_type</span><span class="p">,</span>
                          <span class="n">metric_kwargs</span><span class="o">=</span><span class="n">metric_kwargs</span><span class="p">,</span>
                          <span class="n">cross_check</span><span class="o">=</span><span class="n">cross_check</span><span class="p">)</span>

    <span class="n">desc1_match_idx</span> <span class="o">=</span> <span class="n">matches</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">matched_kp1_xy</span> <span class="o">=</span> <span class="n">kp1_xy</span><span class="p">[</span><span class="n">desc1_match_idx</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">matched_desc1</span> <span class="o">=</span> <span class="n">desc1</span><span class="p">[</span><span class="n">desc1_match_idx</span><span class="p">,</span> <span class="p">:]</span>

    <span class="n">desc2_match_idx</span> <span class="o">=</span> <span class="n">matches</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">matched_kp2_xy</span> <span class="o">=</span> <span class="n">kp2_xy</span><span class="p">[</span><span class="n">desc2_match_idx</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">matched_desc2</span> <span class="o">=</span> <span class="n">desc2</span><span class="p">[</span><span class="n">desc2_match_idx</span><span class="p">,</span> <span class="p">:]</span>

    <span class="n">mean_unfiltered_distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">match_distances</span><span class="p">)</span>
    <span class="n">mean_unfiltered_similarity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">convert_distance_to_similarity</span><span class="p">(</span><span class="n">match_distances</span><span class="p">,</span> <span class="n">n_features</span><span class="o">=</span><span class="n">desc1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="n">match_info12</span> <span class="o">=</span> <span class="n">MatchInfo</span><span class="p">(</span><span class="n">matched_kp1_xy</span><span class="o">=</span><span class="n">matched_kp1_xy</span><span class="p">,</span> <span class="n">matched_desc1</span><span class="o">=</span><span class="n">matched_desc1</span><span class="p">,</span>
                             <span class="n">matches12</span><span class="o">=</span><span class="n">desc1_match_idx</span><span class="p">,</span> <span class="n">matched_kp2_xy</span><span class="o">=</span><span class="n">matched_kp2_xy</span><span class="p">,</span>
                             <span class="n">matched_desc2</span><span class="o">=</span><span class="n">matched_desc2</span><span class="p">,</span> <span class="n">matches21</span><span class="o">=</span><span class="n">desc2_match_idx</span><span class="p">,</span>
                             <span class="n">match_distances</span><span class="o">=</span><span class="n">match_distances</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="n">mean_unfiltered_distance</span><span class="p">,</span>
                             <span class="n">similarity</span><span class="o">=</span><span class="n">mean_unfiltered_similarity</span><span class="p">,</span> <span class="n">metric_name</span><span class="o">=</span><span class="n">metric_name</span><span class="p">,</span>
                             <span class="n">metric_type</span><span class="o">=</span><span class="n">metric_type</span><span class="p">)</span>

    <span class="n">match_info21</span> <span class="o">=</span> <span class="n">MatchInfo</span><span class="p">(</span><span class="n">matched_kp1_xy</span><span class="o">=</span><span class="n">matched_kp2_xy</span><span class="p">,</span> <span class="n">matched_desc1</span><span class="o">=</span><span class="n">matched_desc2</span><span class="p">,</span>
                             <span class="n">matches12</span><span class="o">=</span><span class="n">desc2_match_idx</span><span class="p">,</span> <span class="n">matched_kp2_xy</span><span class="o">=</span><span class="n">matched_kp1_xy</span><span class="p">,</span>
                             <span class="n">matched_desc2</span><span class="o">=</span><span class="n">matched_desc1</span><span class="p">,</span> <span class="n">matches21</span><span class="o">=</span><span class="n">desc1_match_idx</span><span class="p">,</span>
                             <span class="n">match_distances</span><span class="o">=</span><span class="n">match_distances</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="n">mean_unfiltered_distance</span><span class="p">,</span>
                             <span class="n">similarity</span><span class="o">=</span><span class="n">mean_unfiltered_similarity</span><span class="p">,</span> <span class="n">metric_name</span><span class="o">=</span><span class="n">metric_name</span><span class="p">,</span>
                             <span class="n">metric_type</span><span class="o">=</span><span class="n">metric_type</span><span class="p">)</span>

    <span class="c1"># Filter matches #</span>
    <span class="n">all_filtering_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;kp1_xy&quot;</span><span class="p">:</span> <span class="n">matched_kp1_xy</span><span class="p">,</span> <span class="s2">&quot;kp2_xy&quot;</span><span class="p">:</span> <span class="n">matched_kp2_xy</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">filtering_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">filter_method</span> <span class="o">!=</span> <span class="n">RANSAC_NAME</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="ne">Warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;filtering_kwargs not provided for </span><span class="si">{</span><span class="n">filter_method</span><span class="si">}</span><span class="s2"> match filtering. Will use RANSAC instead&quot;</span><span class="p">))</span>
            <span class="n">filter_method</span> <span class="o">=</span> <span class="n">RANSAC_NAME</span>
            <span class="n">all_filtering_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;ransac_val&quot;</span><span class="p">:</span> <span class="n">DEFAULT_RANSAC</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">all_filtering_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;ransac_val&quot;</span><span class="p">:</span> <span class="n">DEFAULT_RANSAC</span><span class="p">})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">all_filtering_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">filtering_kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">filter_method</span> <span class="o">==</span> <span class="n">GMS_NAME</span><span class="p">:</span>
            <span class="c1"># At this point, filtering_kwargs needs to include:</span>
            <span class="c1"># img1_shape, img2_shape, scaling, and thresholdFactor.</span>
            <span class="c1"># Already added kp1_xy, kp2_xy. Now adding feature_d to</span>
            <span class="c1"># the argument dictionary</span>

            <span class="n">all_filtering_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;feature_d&quot;</span><span class="p">:</span> <span class="n">match_distances</span><span class="p">})</span>

    <span class="n">filtered_matched_kp1_xy</span><span class="p">,</span> <span class="n">filtered_matched_kp2_xy</span><span class="p">,</span> <span class="n">good_matches_idx</span> <span class="o">=</span> \
        <span class="n">filter_matches</span><span class="p">(</span><span class="n">matched_kp1_xy</span><span class="p">,</span> <span class="n">matched_kp2_xy</span><span class="p">,</span> <span class="n">filter_method</span><span class="p">,</span> <span class="n">all_filtering_kwargs</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">good_matches_idx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">filterd_match_distances</span> <span class="o">=</span> <span class="n">match_distances</span><span class="p">[</span><span class="n">good_matches_idx</span><span class="p">]</span>
        <span class="n">filterd_matched_desc1</span> <span class="o">=</span> <span class="n">matched_desc1</span><span class="p">[</span><span class="n">good_matches_idx</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">filterd_matched_desc2</span> <span class="o">=</span> <span class="n">matched_desc2</span><span class="p">[</span><span class="n">good_matches_idx</span><span class="p">,</span> <span class="p">:]</span>

        <span class="n">good_matches12</span> <span class="o">=</span> <span class="n">desc1_match_idx</span><span class="p">[</span><span class="n">good_matches_idx</span><span class="p">]</span>
        <span class="n">good_matches21</span> <span class="o">=</span> <span class="n">desc2_match_idx</span><span class="p">[</span><span class="n">good_matches_idx</span><span class="p">]</span>

        <span class="n">mean_filtered_distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">filterd_match_distances</span><span class="p">)</span>
        <span class="n">mean_filtered_similarity</span> <span class="o">=</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">convert_distance_to_similarity</span><span class="p">(</span><span class="n">filterd_match_distances</span><span class="p">,</span>
                                                   <span class="n">n_features</span><span class="o">=</span><span class="n">desc1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">filterd_match_distances</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">filterd_matched_desc1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">filterd_matched_desc2</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">good_matches12</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">good_matches21</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">mean_filtered_distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="n">mean_filtered_similarity</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Record filtered matches</span>
    <span class="n">filtered_match_info12</span> <span class="o">=</span> <span class="n">MatchInfo</span><span class="p">(</span><span class="n">matched_kp1_xy</span><span class="o">=</span><span class="n">filtered_matched_kp1_xy</span><span class="p">,</span> <span class="n">matched_desc1</span><span class="o">=</span><span class="n">filterd_matched_desc1</span><span class="p">,</span>
                                      <span class="n">matches12</span><span class="o">=</span><span class="n">good_matches12</span><span class="p">,</span> <span class="n">matched_kp2_xy</span><span class="o">=</span><span class="n">filtered_matched_kp2_xy</span><span class="p">,</span>
                                      <span class="n">matched_desc2</span><span class="o">=</span><span class="n">filterd_matched_desc2</span><span class="p">,</span> <span class="n">matches21</span><span class="o">=</span><span class="n">good_matches21</span><span class="p">,</span>
                                      <span class="n">match_distances</span><span class="o">=</span><span class="n">filterd_match_distances</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="n">mean_filtered_distance</span><span class="p">,</span>
                                      <span class="n">similarity</span><span class="o">=</span><span class="n">mean_filtered_similarity</span><span class="p">,</span> <span class="n">metric_name</span><span class="o">=</span><span class="n">metric_name</span><span class="p">,</span>
                                      <span class="n">metric_type</span><span class="o">=</span><span class="n">metric_type</span><span class="p">)</span>

    <span class="n">filtered_match_info21</span> <span class="o">=</span> <span class="n">MatchInfo</span><span class="p">(</span><span class="n">matched_kp1_xy</span><span class="o">=</span><span class="n">filtered_matched_kp2_xy</span><span class="p">,</span> <span class="n">matched_desc1</span><span class="o">=</span><span class="n">filterd_matched_desc2</span><span class="p">,</span>
                                      <span class="n">matches12</span><span class="o">=</span><span class="n">good_matches21</span><span class="p">,</span> <span class="n">matched_kp2_xy</span><span class="o">=</span><span class="n">filtered_matched_kp1_xy</span><span class="p">,</span>
                                      <span class="n">matched_desc2</span><span class="o">=</span><span class="n">filterd_matched_desc1</span><span class="p">,</span> <span class="n">matches21</span><span class="o">=</span><span class="n">good_matches12</span><span class="p">,</span>
                                      <span class="n">match_distances</span><span class="o">=</span><span class="n">filterd_match_distances</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="n">mean_filtered_distance</span><span class="p">,</span>
                                      <span class="n">similarity</span><span class="o">=</span><span class="n">mean_filtered_similarity</span><span class="p">,</span> <span class="n">metric_name</span><span class="o">=</span><span class="n">metric_name</span><span class="p">,</span>
                                      <span class="n">metric_type</span><span class="o">=</span><span class="n">metric_type</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">match_info12</span><span class="p">,</span> <span class="n">filtered_match_info12</span><span class="p">,</span> <span class="n">match_info21</span><span class="p">,</span> <span class="n">filtered_match_info21</span></div>


<div class="viewcode-block" id="MatchInfo"><a class="viewcode-back" href="../../feature_matcher.html#valis.feature_matcher.MatchInfo">[docs]</a><span class="k">class</span> <span class="nc">MatchInfo</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class that stores information related to matches. One per pair of images</span>

<span class="sd">    All attributes are all set as parameters during initialization</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="MatchInfo.__init__"><a class="viewcode-back" href="../../feature_matcher.html#valis.feature_matcher.MatchInfo.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">matched_kp1_xy</span><span class="p">,</span> <span class="n">matched_desc1</span><span class="p">,</span> <span class="n">matches12</span><span class="p">,</span>
                 <span class="n">matched_kp2_xy</span><span class="p">,</span> <span class="n">matched_desc2</span><span class="p">,</span> <span class="n">matches21</span><span class="p">,</span>
                 <span class="n">match_distances</span><span class="p">,</span> <span class="n">distance</span><span class="p">,</span> <span class="n">similarity</span><span class="p">,</span>
                 <span class="n">metric_name</span><span class="p">,</span> <span class="n">metric_type</span><span class="p">,</span>
                 <span class="n">img1_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">img2_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Stores information about matches and features</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        matched_kp1_xy : ndarray</span>
<span class="sd">            (Q, 2) array of image 1 keypoint xy coordinates after filtering</span>

<span class="sd">        matched_desc1 : ndarray</span>
<span class="sd">            (Q, P) array of matched descriptors for image 1, each of which has P features</span>

<span class="sd">        matches12 : ndarray</span>
<span class="sd">            (1, Q) array of indices of featiures in image 1 that matched those in image 2</span>

<span class="sd">        matched_kp2_xy : ndarray</span>
<span class="sd">            (Q, 2) array containing Q matched image 2 keypoint xy coordinates after filtering</span>

<span class="sd">        matched_desc2 : ndarray</span>
<span class="sd">            (Q, P) containing Q matched descriptors for image 2, each of which has P features</span>

<span class="sd">        matches21 : ndarray</span>
<span class="sd">            (1, Q) containing indices of featiures in image 2 that matched those in image 1</span>

<span class="sd">        match_distances : ndarray</span>
<span class="sd">            Distances between each of the Q pairs of matched descriptors</span>

<span class="sd">        n_matches : int</span>
<span class="sd">            Number of good matches (i.e. the number of inlier keypoints)</span>

<span class="sd">        distance : float</span>
<span class="sd">            Mean distance of features</span>

<span class="sd">        similarity : float</span>
<span class="sd">            Mean similarity of features</span>

<span class="sd">        metric_name : str</span>
<span class="sd">            Name of metric</span>

<span class="sd">        metric_type : str</span>
<span class="sd">            &quot;distsnce&quot; or &quot;similarity&quot;</span>

<span class="sd">        img1_name : str</span>
<span class="sd">            Name of the image that kp1 and desc1 belong to</span>

<span class="sd">        img2_name : str</span>
<span class="sd">            Name of the image that kp2 and desc2 belong to</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">matched_kp1_xy</span> <span class="o">=</span> <span class="n">matched_kp1_xy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">matched_desc1</span> <span class="o">=</span> <span class="n">matched_desc1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">matches12</span> <span class="o">=</span> <span class="n">matches12</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">matched_kp2_xy</span> <span class="o">=</span> <span class="n">matched_kp2_xy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">matched_desc2</span> <span class="o">=</span> <span class="n">matched_desc2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">matches21</span> <span class="o">=</span> <span class="n">matches21</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">match_distances</span> <span class="o">=</span> <span class="n">match_distances</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_matches</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">match_distances</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distance</span> <span class="o">=</span> <span class="n">distance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">similarity</span> <span class="o">=</span> <span class="n">similarity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metric_name</span> <span class="o">=</span> <span class="n">metric_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metric_type</span> <span class="o">=</span> <span class="n">metric_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">img1_name</span> <span class="o">=</span> <span class="n">img1_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">img2_name</span> <span class="o">=</span> <span class="n">img2_name</span></div>

    <span class="k">def</span> <span class="nf">set_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img1_name</span><span class="p">,</span> <span class="n">img2_name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">img1_name</span> <span class="o">=</span> <span class="n">img1_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">img2_name</span> <span class="o">=</span> <span class="n">img2_name</span></div>


<div class="viewcode-block" id="Matcher"><a class="viewcode-back" href="../../feature_matcher.html#valis.feature_matcher.Matcher">[docs]</a><span class="k">class</span> <span class="nc">Matcher</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class that matchs the descriptors of image 1 with those of image 2</span>

<span class="sd">    Outliers removed using RANSAC or GMS</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    metric: str, or callable</span>
<span class="sd">        Metric to calculate distance between each pair of features in</span>
<span class="sd">        desc1 and desc2. Can be a string to use as distance in</span>
<span class="sd">        spatial.distance.cdist, or a custom distance function</span>

<span class="sd">    metric_name: str</span>
<span class="sd">        Name metric used. Will be the same as metric if metric is string.</span>
<span class="sd">        If metric is function, this will be the name of the function.</span>

<span class="sd">    metric_type: str, or callable</span>
<span class="sd">        String describing what the custom metric function returns, e.g.</span>
<span class="sd">        &#39;similarity&#39; or &#39;distance&#39;. If None, and metric is a function it</span>
<span class="sd">        is assumed to be a distance, but there will be a warning that this</span>
<span class="sd">        variable should be provided to either define that it is a</span>
<span class="sd">        similarity, or to avoid the warning by having</span>
<span class="sd">        metric_type=&#39;distance&#39; In the case of similarity, the number of</span>
<span class="sd">        features will be used to convert distances</span>

<span class="sd">    ransac : int</span>
<span class="sd">        The residual threshold to determine if a match is an inlier.</span>
<span class="sd">        Only used if filter_method == {RANSAC_NAME}. Default is &quot;RANSAC&quot;</span>

<span class="sd">    gms_threshold : int</span>
<span class="sd">        Used when filter_method is &quot;GMS&quot;.</span>
<span class="sd">        The higher, the fewer matches.</span>

<span class="sd">    scaling: bool</span>
<span class="sd">        Whether or not image scaling should be considered when</span>
<span class="sd">        filter_method is &quot;GMS&quot;</span>

<span class="sd">    metric_kwargs : dict</span>
<span class="sd">        Keyword arguments passed into the metric when calling</span>
<span class="sd">        spatial.distance.cdist</span>

<span class="sd">    match_filter_method: str</span>
<span class="sd">        &quot;GMS&quot; will use filter_matches_gms() to remove poor matches.</span>
<span class="sd">        This uses the Grid-based Motion Statistics (GMS) or RANSAC.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Matcher.__init__"><a class="viewcode-back" href="../../feature_matcher.html#valis.feature_matcher.Matcher.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metric_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metric_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">match_filter_method</span><span class="o">=</span><span class="n">DEFAULT_MATCH_FILTER</span><span class="p">,</span> <span class="n">ransac_thresh</span><span class="o">=</span><span class="n">DEFAULT_RANSAC</span><span class="p">,</span>
                 <span class="n">gms_threshold</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">scaling</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        metric: str, or callable</span>
<span class="sd">            Metric to calculate distance between each pair of features in</span>
<span class="sd">            desc1 and desc2. Can be a string to use as distance in</span>
<span class="sd">            spatial.distance.cdist, or a custom distance function</span>

<span class="sd">        metric_type: str, or callable</span>
<span class="sd">            String describing what the custom metric function returns, e.g.</span>
<span class="sd">            &#39;similarity&#39; or &#39;distance&#39;. If None, and metric is a function it</span>
<span class="sd">            is assumed to be a distance, but there will be a warning that this</span>
<span class="sd">            variable should be provided to either define that it is a</span>
<span class="sd">            similarity, or to avoid the warning by having</span>
<span class="sd">            metric_type=&#39;distance&#39; In the case of similarity, the number of</span>
<span class="sd">            features will be used to convert distances</span>

<span class="sd">        metric_kwargs : dict</span>
<span class="sd">            Keyword arguments passed into the metric when calling</span>
<span class="sd">            spatial.distance.cdist</span>

<span class="sd">        filter_method: str</span>
<span class="sd">            &quot;GMS&quot; will use filter_matches_gms() to remove poor matches.</span>
<span class="sd">            This uses the Grid-based Motion Statistics (GMS) or RANSAC.</span>

<span class="sd">        ransac_val : int</span>
<span class="sd">            The residual threshold to determine if a match is an inlier.</span>
<span class="sd">            Only used if filter_method is &quot;RANSAC&quot;.</span>

<span class="sd">        gms_threshold : int</span>
<span class="sd">            Used when filter_method is &quot;GMS&quot;.</span>
<span class="sd">            The higher, the fewer matches.</span>

<span class="sd">        scaling: bool</span>
<span class="sd">            Whether or not image scaling should be considered when</span>
<span class="sd">            filter_method is &quot;GMS&quot;.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">metric</span> <span class="o">=</span> <span class="n">metric</span>
        <span class="k">if</span> <span class="n">metric</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metric_name</span> <span class="o">=</span> <span class="n">metric</span>
            <span class="k">elif</span> <span class="n">callable</span><span class="p">(</span><span class="n">metric</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metric_name</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metric_name</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">metric_type</span> <span class="o">=</span> <span class="n">metric_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ransac</span> <span class="o">=</span> <span class="n">ransac_thresh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gms_threshold</span> <span class="o">=</span> <span class="n">gms_threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaling</span> <span class="o">=</span> <span class="n">scaling</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metric_kwargs</span> <span class="o">=</span> <span class="n">metric_kwargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">match_filter_method</span> <span class="o">=</span> <span class="n">match_filter_method</span></div>

<div class="viewcode-block" id="Matcher.match_images"><a class="viewcode-back" href="../../feature_matcher.html#valis.feature_matcher.Matcher.match_images">[docs]</a>    <span class="k">def</span> <span class="nf">match_images</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">desc1</span><span class="p">,</span> <span class="n">kp1_xy</span><span class="p">,</span> <span class="n">desc2</span><span class="p">,</span> <span class="n">kp2_xy</span><span class="p">,</span>
                     <span class="n">additional_filtering_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Match the descriptors of image 1 with those of image 2,</span>
<span class="sd">        Outliers removed using match_filter_method. Metric can be a string</span>
<span class="sd">        to use a distance in scipy.distnce.cdist(), or a custom distance</span>
<span class="sd">        function. Sets atttributes for Matcher object</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        desc1 : (N, P) array</span>
<span class="sd">            Image 1s 2D array containinng N keypoints, each of which</span>
<span class="sd">            has P features</span>

<span class="sd">        kp1_xy : (N, 2) array</span>
<span class="sd">            Image 1s keypoint positions, in xy coordinates,  for each of the</span>
<span class="sd">            N descriptors in desc1</span>

<span class="sd">        desc2 : (M, P) array</span>
<span class="sd">            Image 2s 2D array containinng M keypoints, each of which has</span>
<span class="sd">            P features</span>

<span class="sd">        kp2_xy : (M, 2) array</span>
<span class="sd">            Image 1s keypoint positions, in xy coordinates, for each of</span>
<span class="sd">            the M descriptors in desc2</span>

<span class="sd">        additional_filtering_kwargs: dict, optional</span>
<span class="sd">            Extra arguments passed to filtering function</span>
<span class="sd">            If self.match_filter_method == &quot;GMS&quot;, these need to</span>
<span class="sd">            include: img1_shape, img2_shape. See filter_matches_gms for details</span>
<span class="sd">            If If self.match_filter_method == &quot;RANSAC&quot;, this can be None,</span>
<span class="sd">            since the ransac value is class attribute</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        match_info12 : MatchInfo</span>
<span class="sd">                Contains information regarding the matches between image 1</span>
<span class="sd">                and image 2. These results haven&#39;t undergone filtering,</span>
<span class="sd">                so contain many poor matches.</span>

<span class="sd">        filtered_match_info12 : MatchInfo</span>
<span class="sd">                Contains information regarding the matches between image 1</span>
<span class="sd">                and image 2. These results have undergone</span>
<span class="sd">                filtering, and so contain good matches</span>

<span class="sd">        match_info21 : MatchInfo</span>
<span class="sd">                Contains information regarding the matches between image 2</span>
<span class="sd">                and image 1. These results haven&#39;t undergone filtering, so</span>
<span class="sd">                contain many poor matches.</span>

<span class="sd">        filtered_match_info21 : MatchInfo</span>
<span class="sd">                Contains information regarding the matches between image 2</span>
<span class="sd">                and image 1.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_filter_method</span> <span class="o">==</span> <span class="n">GMS_NAME</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">additional_filtering_kwargs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># At this point arguments need to include: img1_shape, img2_shape #</span>
                <span class="n">filtering_kwargs</span> <span class="o">=</span> <span class="n">additional_filtering_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">filtering_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;scaling&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaling</span><span class="p">,</span>
                                         <span class="s2">&quot;thresholdFactor&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">gms_threshold</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="ne">Warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Selected </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">match_filter_method</span><span class="si">}</span><span class="s2">,</span><span class="se">\</span>
<span class="s2">                              but did not provide argument</span><span class="se">\</span>
<span class="s2">                              additional_filtering_kwargs.</span><span class="se">\</span>
<span class="s2">                              Defaulting to RANSAC&quot;</span><span class="p">))</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">match_filter_method</span> <span class="o">=</span> <span class="n">RANSAC_NAME</span>
                <span class="n">filtering_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ransac_val&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ransac</span><span class="p">}</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_filter_method</span> <span class="o">==</span> <span class="n">RANSAC_NAME</span><span class="p">:</span>
            <span class="n">filtering_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ransac_val&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ransac</span><span class="p">}</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="ne">Warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dont know </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">match_filter_method</span><span class="si">}</span><span class="s2">.</span><span class="se">\</span>
<span class="s2">                Defaulting to RANSAC&quot;</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">match_filter_method</span> <span class="o">=</span> <span class="n">RANSAC_NAME</span>
            <span class="n">filtering_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ransac_val&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ransac</span><span class="p">}</span>

        <span class="n">match_info12</span><span class="p">,</span> <span class="n">filtered_match_info12</span><span class="p">,</span> <span class="n">match_info21</span><span class="p">,</span> <span class="n">filtered_match_info21</span> <span class="o">=</span> \
            <span class="n">match_desc_and_kp</span><span class="p">(</span><span class="n">desc1</span><span class="p">,</span> <span class="n">kp1_xy</span><span class="p">,</span> <span class="n">desc2</span><span class="p">,</span> <span class="n">kp2_xy</span><span class="p">,</span>
                              <span class="n">metric</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="p">,</span> <span class="n">metric_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metric_type</span><span class="p">,</span>
                              <span class="n">metric_kwargs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metric_kwargs</span><span class="p">,</span>
                              <span class="n">filter_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">match_filter_method</span><span class="p">,</span>
                              <span class="n">filtering_kwargs</span><span class="o">=</span><span class="n">filtering_kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metric_name</span> <span class="o">=</span> <span class="n">match_info12</span><span class="o">.</span><span class="n">metric_name</span>

        <span class="k">return</span> <span class="n">match_info12</span><span class="p">,</span> <span class="n">filtered_match_info12</span><span class="p">,</span> <span class="n">match_info21</span><span class="p">,</span> <span class="n">filtered_match_info21</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2022, Chandler Gatenbee.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>